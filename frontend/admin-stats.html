<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>访问统计 - My Flower Pots</title>
    <link rel="stylesheet" href="css/tailwind-built.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', 'PingFang SC', sans-serif;
            background-color: #f8fafc;
        }

        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
        }

        [v-cloak] {
            display: none;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        input[type="date"] {
            font-family: 'Outfit', sans-serif;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 0.5rem 0.75rem;
            background: white;
            color: #475569;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input[type="date"]:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .preset-btn {
            padding: 0.375rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: 500;
            border: 1px solid #e2e8f0;
            background: white;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-btn:hover {
            border-color: #10b981;
            color: #10b981;
        }

        .preset-btn.active {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        /* 趋势图 */
        .trend-chart {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 120px;
            padding: 0 4px;
        }

        .trend-bar {
            flex: 1;
            min-width: 4px;
            max-width: 24px;
            background: linear-gradient(to top, #10b981, #34d399);
            border-radius: 3px 3px 0 0;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .trend-bar:hover {
            background: linear-gradient(to top, #059669, #10b981);
            transform: scaleY(1.03);
        }

        .trend-bar:hover .trend-tooltip {
            display: block;
        }

        .trend-tooltip {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 6px;
            white-space: nowrap;
            margin-bottom: 4px;
            z-index: 10;
        }

        .trend-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: #1e293b;
        }

        .trend-x-labels {
            display: flex;
            gap: 2px;
            padding: 0 4px;
        }

        .trend-x-labels span {
            flex: 1;
            min-width: 4px;
            max-width: 24px;
            text-align: center;
            font-size: 9px;
            color: #94a3b8;
            overflow: hidden;
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <div id="app" v-cloak>
        <!-- Security Loading Overlay -->
        <div v-if="isCheckingAccess" class="loading-overlay">
            <div class="w-16 h-16 border-4 border-emerald-500/20 border-t-emerald-500 rounded-full animate-spin mb-4">
            </div>
            <p class="text-slate-500 font-medium">安全校验中...</p>
        </div>

        <div v-else class="max-w-6xl mx-auto">
            <!-- Header -->
            <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                <div class="cursor-pointer group" onclick="window.location.href='admin-plants.html'">
                    <h1
                        class="text-3xl font-bold text-slate-800 flex items-center gap-3 transition-colors group-hover:text-emerald-600">
                        <i class="fas fa-chart-line text-emerald-500"></i>
                        页面访问统计
                    </h1>
                    <p class="text-slate-500 mt-1 flex items-center gap-1">
                        <i class="fas fa-arrow-left text-xs opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        返回管理中心
                    </p>
                </div>
            </header>

            <!-- 日期筛选工具栏 -->
            <div class="glass border border-white rounded-2xl p-4 mb-6 shadow-sm">
                <div class="flex flex-wrap items-center gap-2 mb-3">
                    <span class="text-sm text-slate-500 font-medium mr-1">
                        <i class="fas fa-clock mr-1"></i>快捷:
                    </span>
                    <button v-for="p in presets" :key="p.label" class="preset-btn"
                        :class="{ active: activePreset === p.label }" @click="applyPreset(p)">
                        {{ p.label }}
                    </button>
                </div>
                <div class="flex flex-wrap items-center gap-3">
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-slate-500">从</label>
                        <input type="date" v-model="startDate" @change="activePreset = ''" />
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-slate-500">到</label>
                        <input type="date" v-model="endDate" @change="activePreset = ''" />
                    </div>
                    <button @click="loadStats"
                        class="ml-auto px-4 py-2 bg-emerald-500 text-white rounded-xl hover:bg-emerald-600 shadow-lg shadow-emerald-200 transition-all flex items-center gap-2 text-sm font-medium">
                        <i class="fas fa-search" :class="{'fa-spin': loading}"></i>
                        {{ loading ? '查询中...' : '查询' }}
                    </button>
                    <button @click="clearFilter"
                        class="px-4 py-2 border border-slate-200 text-slate-500 rounded-xl hover:border-emerald-300 hover:text-emerald-500 transition-all flex items-center gap-2 text-sm">
                        <i class="fas fa-times"></i>
                        全部
                    </button>
                </div>
            </div>

            <!-- 汇总卡片 -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <!-- 今日访问 -->
                <div class="glass border border-white rounded-2xl p-4 shadow-sm text-center">
                    <div class="text-2xl font-bold text-emerald-600">{{ todayVisits }}</div>
                    <div class="text-xs text-slate-400 mt-1">今日访问</div>
                    <div class="text-xs mt-1" :class="todayDiff >= 0 ? 'text-emerald-500' : 'text-red-400'">
                        <i :class="todayDiff >= 0 ? 'fas fa-arrow-up' : 'fas fa-arrow-down'"></i>
                        {{ Math.abs(todayDiff) }} 较昨日
                    </div>
                </div>
                <!-- 昨日访问 -->
                <div class="glass border border-white rounded-2xl p-4 shadow-sm text-center">
                    <div class="text-2xl font-bold text-sky-600">{{ yesterdayVisits }}</div>
                    <div class="text-xs text-slate-400 mt-1">昨日访问</div>
                </div>
                <!-- 总访问量 -->
                <div class="glass border border-white rounded-2xl p-4 shadow-sm text-center">
                    <div class="text-2xl font-bold text-violet-600">{{ totalVisits }}</div>
                    <div class="text-xs text-slate-400 mt-1">{{ hasFilter ? '筛选范围' : '累计' }}总量</div>
                </div>
                <!-- 页面数 -->
                <div class="glass border border-white rounded-2xl p-4 shadow-sm text-center">
                    <div class="text-2xl font-bold text-amber-600">{{ stats.length }}</div>
                    <div class="text-xs text-slate-400 mt-1">页面数</div>
                </div>
                <!-- 日均 -->
                <div class="glass border border-white rounded-2xl p-4 shadow-sm text-center">
                    <div class="text-2xl font-bold text-pink-600">{{ dailyAvg }}</div>
                    <div class="text-xs text-slate-400 mt-1">日均访问</div>
                </div>
            </div>

            <!-- 每日趋势图 -->
            <div class="glass border border-white rounded-2xl p-5 mb-6 shadow-sm" v-if="trend.length > 0">
                <h3 class="text-sm font-semibold text-slate-600 mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-bar text-emerald-500"></i>
                    每日访问趋势
                    <span class="text-xs font-normal text-slate-400">
                        ({{ trend.length }} 天)
                    </span>
                </h3>
                <!-- Y 轴参考线 -->
                <div class="relative">
                    <div class="absolute left-0 top-0 h-full w-8 flex flex-col justify-between text-right pr-1"
                        style="height: 120px;">
                        <span class="text-[10px] text-slate-300">{{ trendMax }}</span>
                        <span class="text-[10px] text-slate-300">{{ Math.round(trendMax / 2) }}</span>
                        <span class="text-[10px] text-slate-300">0</span>
                    </div>
                    <div class="ml-9">
                        <!-- 柱状图 -->
                        <div class="trend-chart">
                            <div v-for="item in trend" :key="item.visit_date" class="trend-bar"
                                :style="{ height: getBarHeight(item.total_visits) }">
                                <div class="trend-tooltip">
                                    {{ item.visit_date.slice(5) }}: {{ item.total_visits }} 次
                                </div>
                            </div>
                        </div>
                        <!-- X 轴标签 -->
                        <div class="trend-x-labels mt-1">
                            <span v-for="(item, idx) in trend" :key="'l'+item.visit_date">
                                {{ shouldShowLabel(idx) ? item.visit_date.slice(5) : '' }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="glass border border-white rounded-2xl overflow-hidden shadow-sm">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-4 font-semibold text-slate-600">#</th>
                            <th class="px-6 py-4 font-semibold text-slate-600">页面路径</th>
                            <th class="px-6 py-4 font-semibold text-slate-600">访问次数</th>
                            <th class="px-6 py-4 font-semibold text-slate-600">占比</th>
                            <th class="px-6 py-4 font-semibold text-slate-600">最后访问</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        <tr v-if="stats.length === 0 && !loading">
                            <td colspan="5" class="px-6 py-12 text-center text-slate-400">
                                <i class="fas fa-chart-bar text-3xl mb-3 block opacity-30"></i>
                                {{ hasFilter ? '所选日期范围内暂无数据' : '暂无访问数据' }}
                            </td>
                        </tr>
                        <tr v-for="(item, idx) in stats" :key="item.path"
                            class="hover:bg-emerald-50/50 transition-colors">
                            <td class="px-6 py-4 text-slate-400 text-sm">{{ idx + 1 }}</td>
                            <td class="px-6 py-4 font-mono text-slate-600 text-sm">
                                {{ item.path }}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-3">
                                    <div class="flex-1 max-w-[120px] bg-slate-100 rounded-full h-2 overflow-hidden">
                                        <div class="bg-emerald-500 h-full rounded-full transition-all"
                                            :style="{ width: getTableBarWidth(item.visit_count) }"></div>
                                    </div>
                                    <span class="text-sm font-semibold text-emerald-600 min-w-[3rem] text-right">
                                        {{ item.visit_count }}
                                    </span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-slate-400 text-sm">
                                {{ getPercent(item.visit_count) }}%
                            </td>
                            <td class="px-6 py-4 text-slate-400 text-sm">
                                {{ formatDateTime(item.last_updated) }}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 底部信息 -->
            <div class="text-center text-xs text-slate-400 mt-6" v-if="hasFilter">
                <i class="fas fa-info-circle mr-1"></i>
                当前显示 {{ startDate }} 至 {{ endDate }} 的数据
            </div>
        </div>

        <!-- Toast -->
        <div v-if="toast.show"
            class="fixed bottom-8 left-1/2 -translate-x-1/2 px-6 py-3 bg-slate-800 text-white rounded-2xl shadow-xl flex items-center gap-3 animate-bounce">
            <i :class="toast.icon"></i>
            {{ toast.message }}
        </div>
    </div>

    <script src="js/api-client.js"></script>
    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const stats = ref([]);
                const trend = ref([]);
                const todayVisits = ref(0);
                const yesterdayVisits = ref(0);
                const loading = ref(false);
                const isCheckingAccess = ref(true);
                const toast = ref({ show: false, message: '', icon: '' });

                const startDate = ref('');
                const endDate = ref('');
                const activePreset = ref('');

                const presets = [
                    { label: '今天', days: 0 },
                    { label: '近7天', days: 7 },
                    { label: '近30天', days: 30 },
                    { label: '近90天', days: 90 },
                ];

                const hasFilter = computed(() => startDate.value && endDate.value);
                const totalVisits = computed(() => stats.value.reduce((s, i) => s + i.visit_count, 0));
                const todayDiff = computed(() => todayVisits.value - yesterdayVisits.value);
                const trendMax = computed(() => {
                    if (trend.value.length === 0) return 0;
                    return Math.max(...trend.value.map(t => t.total_visits));
                });
                const dailyAvg = computed(() => {
                    if (trend.value.length === 0) return 0;
                    const sum = trend.value.reduce((s, t) => s + t.total_visits, 0);
                    return Math.round(sum / trend.value.length);
                });

                const showToast = (msg, icon = 'fas fa-info-circle') => {
                    toast.value = { show: true, message: msg, icon };
                    setTimeout(() => toast.value.show = false, 3000);
                };

                const getToday = () => new Date().toISOString().split('T')[0];
                const getDaysAgo = (days) => {
                    const d = new Date();
                    d.setDate(d.getDate() - days);
                    return d.toISOString().split('T')[0];
                };

                const applyPreset = (preset) => {
                    activePreset.value = preset.label;
                    endDate.value = getToday();
                    startDate.value = getDaysAgo(preset.days);
                    loadStats();
                };

                const clearFilter = () => {
                    startDate.value = '';
                    endDate.value = '';
                    activePreset.value = '';
                    loadStats();
                };

                const checkAccess = async () => {
                    try {
                        const token = localStorage.getItem('flowerpots_token');
                        if (!token) throw new Error('No token');

                        const res = await fetch('/api/admin/check', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if (!res.ok) throw new Error('Unauthorized');

                        isCheckingAccess.value = false;
                        loadStats();
                    } catch (err) {
                        console.error('Access denied:', err);
                        window.location.href = '/index.html';
                    }
                };

                const loadStats = async () => {
                    loading.value = true;
                    try {
                        const token = localStorage.getItem('flowerpots_token');
                        let url = '/api/admin/analytics';
                        if (startDate.value && endDate.value) {
                            url += `?startDate=${startDate.value}&endDate=${endDate.value}`;
                        }
                        const res = await fetch(url, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const data = await res.json();
                        if (data.success) {
                            stats.value = data.data || [];
                            trend.value = data.trend || [];
                            todayVisits.value = data.today || 0;
                            yesterdayVisits.value = data.yesterday || 0;
                        } else {
                            throw new Error(data.message);
                        }
                    } catch (err) {
                        showToast('加载失败: ' + err.message, 'fas fa-exclamation-circle');
                    } finally {
                        loading.value = false;
                    }
                };

                const getBarHeight = (count) => {
                    if (trendMax.value === 0) return '2px';
                    return Math.max(2, (count / trendMax.value) * 100) + '%';
                };

                const shouldShowLabel = (idx) => {
                    const len = trend.value.length;
                    if (len <= 7) return true;
                    if (len <= 14) return idx % 2 === 0;
                    if (len <= 31) return idx % 5 === 0 || idx === len - 1;
                    return idx % 10 === 0 || idx === len - 1;
                };

                const getTableBarWidth = (count) => {
                    if (stats.value.length === 0) return '0%';
                    const max = stats.value[0].visit_count;
                    return Math.max(5, (count / max) * 100) + '%';
                };

                const getPercent = (count) => {
                    if (totalVisits.value === 0) return '0.0';
                    return ((count / totalVisits.value) * 100).toFixed(1);
                };

                const formatDateTime = (dateStr) => {
                    if (!dateStr) return '-';
                    if (dateStr.length === 10) return dateStr;
                    // D1 的 datetime('now') 返回 UTC，需要加 'Z' 后缀让 JS 正确识别时区
                    const utcStr = dateStr.endsWith('Z') ? dateStr : dateStr.replace(' ', 'T') + 'Z';
                    return new Date(utcStr).toLocaleString('zh-CN', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit'
                    });
                };

                onMounted(() => {
                    checkAccess();
                });

                return {
                    stats, trend, todayVisits, yesterdayVisits,
                    loading, isCheckingAccess, toast,
                    startDate, endDate, activePreset, presets,
                    hasFilter, totalVisits, todayDiff, trendMax, dailyAvg,
                    loadStats, clearFilter, applyPreset,
                    getBarHeight, shouldShowLabel,
                    getTableBarWidth, getPercent, formatDateTime
                };
            }
        }).mount('#app');
    </script>
</body>

</html>