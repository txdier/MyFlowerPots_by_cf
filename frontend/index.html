<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„èŠ±ç›†</title>
    <!-- v2.0.3 - Selection UI Optimization -->

    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Tailwind CSS & Custom Styles (Optimized) -->
    <link rel="stylesheet" href="css/tailwind-built.css">

    <!-- å›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- é…ç½®è„šæœ¬ -->
    <script src="js/config.js?v=20260118"></script>
    <script src="js/api-client.js?v=20260118"></script>
    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
</head>

<body class="bg-gray-50 pb-24">
    <div id="app" v-cloak>
        <!-- é¡¶éƒ¨å¯¼èˆªæ  (å…¨å®½åˆ†å¸ƒ) -->
        <header class="header bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-gray-50 h-16 w-full">
            <div class="w-full h-full px-4 flex justify-between items-center">
                <!-- 1. å·¦ä¾§ï¼šç®¡ç†æ¨¡å¼ -->
                <div class="flex items-center gap-2">
                    <template v-if="isEditMode">
                        <button @click="toggleSelectAll"
                            class="bg-green-50 text-green-600 px-3 py-1.5 rounded-full font-black text-xs transition active:scale-95">
                            {{ allSelected ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰' }}
                        </button>
                        <button @click="toggleEditMode"
                            class="bg-blue-500 text-white px-3 py-1.5 rounded-full font-black text-xs transition active:scale-95 shadow-sm shadow-blue-200">
                            å®Œæˆ
                        </button>
                    </template>
                    <button v-else-if="pots.length > 0" @click="toggleEditMode"
                        class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-blue-500 transition active:scale-90">
                        <i class="fas fa-list-check text-xl"></i>
                    </button>
                </div>

                <!-- 2. å³ä¾§ï¼šå¤©æ°” + ç”¨æˆ· -->
                <div class="flex items-center gap-2">
                    <!-- å¤©æ°”ç®€æŠ¥ -->
                    <!-- <div v-if="weatherData" class="flex items-center bg-blue-50/50 px-3 py-1.5 rounded-2xl border border-blue-100 text-blue-600 gap-2">
                        <i class="fas fa-cloud-sun text-sm"></i>
                        <div class="flex flex-col">
                            <span class="text-[9px] font-black leading-none mb-0.5">{{ weatherData.location?.name }}</span>
                            <span class="text-[10px] font-black leading-none opacity-80">{{ weatherData.current?.condition }} {{ weatherData.current?.temp }}Â°</span>
                        </div>
                    </div> -->

                    <!-- ç”¨æˆ·ä¿¡æ¯ -->
                    <div class="relative user-menu-container">
                        <button @click="showUserMenu = !showUserMenu"
                            class="flex items-center gap-2 bg-white border border-gray-100 p-1 pr-3 rounded-full shadow-sm hover:shadow-md transition active:scale-95">
                            <img :src="user?.avatarUrl || 'assets/images/icons/profile.png'"
                                class="w-8 h-8 rounded-full shadow-sm object-cover">
                            <span class="text-[10px] font-black text-gray-700 max-w-[80px] truncate">{{ userDisplayName
                                }}</span>
                        </button>
                        <!-- é€æ˜é®ç½©å±‚ï¼Œç‚¹å‡»å…³é—­ä¸‹æ‹‰èœå• -->
                        <div v-if="showUserMenu" class="fixed inset-0 z-40" @click="showUserMenu = false"></div>
                        <!-- ç”¨æˆ·ä¸‹æ‹‰èœå• -->
                        <div v-if="showUserMenu"
                            class="absolute right-0 mt-3 w-40 bg-white rounded-2xl shadow-2xl border border-gray-100 overflow-hidden z-50 animate-fade-in">
                            <div
                                class="px-4 py-3 bg-gray-50 border-b border-gray-100 text-[10px] text-gray-400 font-bold uppercase tracking-widest">
                                è®¾ç½®</div>
                            <button v-if="isLoggedIn && user?.userType !== 'anonymous'" @click="goProfile"
                                class="w-full text-left px-4 py-4 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2 border-b border-gray-50 transition">
                                <i class="fas fa-user-circle text-green-500"></i> ä¸ªäººèµ„æ–™
                            </button>
                            <button v-if="isLoggedIn && user?.isAdmin" @click="goAdmin"
                                class="w-full text-left px-4 py-4 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2 border-b border-gray-50 transition">
                                <i class="fas fa-hammer text-orange-500"></i> ç®¡ç†åå°
                            </button>
                            <!-- åŒ¿åç”¨æˆ·ï¼šæ˜¾ç¤ºæ³¨å†Œå…¥å£ -->
                            <button v-if="isLoggedIn && user?.userType === 'anonymous'"
                                @click="showRegisterModal = true; showUserMenu = false"
                                class="w-full text-left px-4 py-3 text-sm hover:bg-green-50 flex flex-col border-b border-gray-50 transition">
                                <span class="text-green-600 font-medium flex items-center gap-2">
                                    <i class="fas fa-user-plus"></i> æ³¨å†Œè´¦å·
                                </span>
                                <span class="text-[10px] text-gray-400 mt-0.5 ml-6">å¯åˆå¹¶ä¿ç•™å½“å‰æ•°æ®</span>
                            </button>
                            <button v-if="isLoggedIn" @click="logout"
                                class="w-full text-left px-4 py-4 text-sm text-red-500 hover:bg-red-50 flex items-center gap-2 transition active:bg-red-100">
                                <i class="fas fa-sign-out-alt"></i>
                                {{ user?.userType === 'anonymous' ? 'é€€å‡º (æ•°æ®å°†ä¸¢å¤±)' : 'é€€å‡ºç™»å½•' }}
                            </button>
                            <div v-else class="space-y-0.5 px-1 pb-1">
                                <button @click="showLoginModal = true; showUserMenu = false"
                                    class="w-full text-left px-4 py-3 text-sm text-green-600 hover:bg-green-50 flex items-center gap-2 transition rounded-lg active:scale-95">
                                    <i class="fas fa-sign-in-alt w-4 text-center"></i> ç™»å½•
                                </button>
                                <button @click="showRegisterModal = true; showUserMenu = false"
                                    class="w-full text-left px-4 py-3 text-sm text-blue-600 hover:bg-blue-50 flex items-center gap-2 transition rounded-lg active:scale-95">
                                    <i class="fas fa-user-plus w-4 text-center"></i> æ³¨å†Œ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- å…»æŠ¤å»ºè®® -->
        <div v-if="careAdvice.length > 0 && pots.length > 0" class="container mx-auto px-4 mt-4">
            <div
                class="bg-white rounded-2xl p-3 border border-gray-100 flex items-center gap-3 shadow-sm overflow-hidden">
                <div
                    class="bg-yellow-50 text-yellow-600 w-8 h-8 rounded-full flex items-center justify-center shrink-0">
                    <i class="fas fa-lightbulb"></i>
                </div>
                <div class="flex-1 text-sm font-medium text-gray-600 truncate animate-pulse">
                    {{ careAdvice[currentAdviceIndex]?.advice }}
                </div>
            </div>
        </div>

        <!-- ä»Šæ—¥å¾…å…»æŠ¤ (å¯æŠ˜å ) -->
        <div v-if="careReminders.length > 0" class="container mx-auto px-4 mt-4">
            <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                <!-- å¤´éƒ¨ï¼šç‚¹å‡»å¯å±•å¼€/æŠ˜å  -->
                <div @click="showRemindersExpanded = !showRemindersExpanded"
                    class="p-4 flex items-center justify-between cursor-pointer active:bg-gray-50 transition">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-orange-50 flex items-center justify-center text-orange-500">
                            <i class="fas fa-bell"></i>
                        </div>
                        <span class="text-sm font-bold text-gray-800">ä»Šæ—¥å¾…å…»æŠ¤</span>
                        <span class="text-xs font-bold text-orange-500 bg-orange-50 px-2 py-1 rounded-full">{{
                            careReminders.length }}</span>
                    </div>
                    <i class="fas text-gray-400 text-sm transition-transform duration-200"
                        :class="showRemindersExpanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                </div>
                <!-- å±•å¼€å†…å®¹ -->
                <div v-show="showRemindersExpanded"
                    class="divide-y divide-gray-50 max-h-48 overflow-y-auto border-t border-gray-50">
                    <div v-for="reminder in careReminders" :key="reminder.scheduleId"
                        @click.stop="goToPotDetail(reminder.potId)"
                        class="flex items-center gap-3 p-3 cursor-pointer active:bg-gray-50 transition">
                        <img :src="reminder.potImage || 'assets/images/icons/icons-default-pot.png'"
                            class="w-10 h-10 rounded-xl object-cover shrink-0"
                            @error="e => e.target.src = 'assets/images/icons/icons-default-pot.png'">
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-bold text-gray-800 truncate">{{ reminder.potName }}</div>
                            <div class="text-[10px] text-gray-400">
                                {{ reminder.careType === 'water' ? 'ğŸ’§ æµ‡æ°´' : 'ğŸŒ¿ æ–½è‚¥' }}
                                <span class="text-orange-500 ml-1">å·²è¿‡ {{ reminder.daysSinceCare }} å¤©</span>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸»åˆ—è¡¨åŒºåŸŸ -->
        <main class="container mx-auto px-4 mt-6">
            <div v-if="isLoading" class="flex flex-col items-center justify-center py-20">
                <div class="spinner mb-4"></div>
                <p class="text-gray-400 text-sm">æ­£åœ¨æ¬è¿æ‚¨çš„èŠ±ç›†...</p>
            </div>

            <div v-else-if="pots.length === 0" class="flex flex-col items-center justify-center py-20 text-center">
                <div class="w-32 h-32 bg-gray-100 rounded-full flex items-center justify-center mb-6 text-gray-300">
                    <i class="fas fa-seedling text-5xl"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-800">ç©ºç©ºå¦‚ä¹Ÿ</h3>
                <p class="text-gray-400 text-sm mt-2 px-10">æ‚¨è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•èŠ±ç›†ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹è®°å½•ç¬¬ä¸€æ ªæ¤ç‰©å§</p>
                <div class="flex flex-col sm:flex-row gap-3 mt-8">
                    <button @click="goAddPot" class="btn btn-primary px-8 py-3 rounded-2xl shadow-lg shadow-green-100">
                        æ·»åŠ æˆ‘çš„èŠ±ç›†
                    </button>
                    <button @click="seedDemoData" :disabled="isAuthLoading"
                        class="bg-white text-green-600 border border-green-200 px-8 py-3 rounded-2xl shadow-sm hover:bg-green-50 transition active:scale-95 disabled:opacity-50">
                        {{ isAuthLoading ? 'æ­£åœ¨ç”Ÿæˆ...' : 'ä½“éªŒç¤ºä¾‹æ•°æ®' }}
                    </button>
                </div>
            </div>

            <!-- èŠ±ç›†å¡ç‰‡ç½‘æ ¼ -->
            <div v-else ref="potsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div v-for="(pot, index) in pots" :key="pot.id"
                    class="relative bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden transition-all duration-300">

                    <!-- èƒŒæ™¯æ“ä½œå±‚ (ä¾§æ»‘å¯è§) -->
                    <div class="absolute inset-y-0 right-0 w-32 flex">
                        <button @click="goEditPot(pot.id)"
                            class="flex-1 bg-blue-500 text-white flex flex-col items-center justify-center gap-1">
                            <i class="fas fa-edit text-xs"></i>
                            <span class="text-[10px] font-black">ç¼–è¾‘</span>
                        </button>
                        <button @click="confirmDeleteSingle(pot.id)"
                            class="flex-1 bg-red-500 text-white flex flex-col items-center justify-center gap-1">
                            <i class="fas fa-trash-alt text-xs"></i>
                            <span class="text-[10px] font-black">åˆ é™¤</span>
                        </button>
                    </div>

                    <!-- å‰æ™¯å†…å®¹å±‚ -->
                    <div class="relative bg-white flex h-32 transition-all duration-300 ease-out"
                        :class="[isEditMode ? 'pl-[4.5rem]' : '']"
                        :style="{ transform: `translateX(${pot.swipeX || 0}px)` }"
                        @touchstart="handleTouchStart(pot, $event)" @touchmove="handleTouchMove(pot, $event)"
                        @touchend="handleTouchEnd(pot, $event)" @click="handleCardClick(pot)">

                        <!-- ä¾§è¾¹æ“ä½œå° (ä»…åœ¨ç®¡ç†æ¨¡å¼æ˜¾ç¤º) -->
                        <div v-if="isEditMode"
                            class="absolute inset-y-0 left-0 w-[4.5rem] flex flex-col items-center bg-gray-50 border-r border-gray-100 z-30 animate-fade-in">
                            <!-- 1. ä¸ŠåŠéƒ¨ï¼šå‹¾é€‰ -->
                            <div class="flex-1 w-full flex items-center justify-center cursor-pointer"
                                @click.stop="pot.selected = !pot.selected">
                                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all"
                                    :class="pot.selected ? 'border-green-500 bg-green-500 shadow-sm shadow-green-200' : 'border-gray-300 bg-white'">
                                    <i class="fas fa-check text-white text-[10px]" v-show="pot.selected"></i>
                                </div>
                            </div>
                            <!-- åˆ†å‰²ç‚¹ -->
                            <div class="w-1 h-1 rounded-full bg-gray-200"></div>
                            <!-- 2. ä¸‹åŠéƒ¨ï¼šæ‹–æ‹½ -->
                            <div
                                class="flex-1 w-full flex items-center justify-center text-gray-300 handle cursor-move active:text-blue-500 transition hover:bg-gray-100">
                                <i class="fas fa-grip-vertical text-lg"></i>
                            </div>
                        </div>

                        <div class="w-32 h-32 shrink-0 relative p-1">
                            <img :src="pot.image_url || 'assets/images/icons/icons-default-pot.png'"
                                class="w-full h-full object-cover rounded-xl" @error="handleImageError">
                        </div>
                        <div class="flex-1 p-4 flex flex-col justify-between min-w-0">
                            <div>
                                <h3 class="font-bold text-gray-800 truncate">{{ pot.name }}</h3>
                                <p class="text-[11px] text-gray-400 mt-1 truncate">{{ pot.note || 'æš‚æ— å¤‡æ³¨' }}</p>
                            </div>
                            <div class="flex justify-between items-end">
                                <div class="text-xs text-gray-500 flex-1 min-w-0 space-y-1">
                                    <!-- ç§æ¤ä¿¡æ¯ -->
                                    <div class="flex items-center gap-2">
                                        <span class="text-gray-400 shrink-0">ç§æ¤</span>
                                        <span class="font-medium">{{ formatDate(pot.plant_date) }}</span>
                                    </div>
                                    <!-- å…»æŠ¤ä¿¡æ¯ -->
                                    <div class="flex items-center gap-2">
                                        <span class="text-gray-400 shrink-0">å…»æŠ¤</span>
                                        <div
                                            class="flex items-center min-w-0 overflow-hidden text-ellipsis whitespace-nowrap">
                                            <span
                                                :class="pot.last_care ? 'text-green-600 font-medium' : 'text-gray-400'"
                                                class="shrink-0">
                                                {{ pot.last_care ? (formatDate(pot.last_care) || 'æ— ') : 'æ— ' }}
                                            </span>
                                            <!-- å…»æŠ¤åŠ¨ä½œ (è‡ªåŠ¨æ’‘æ»¡å‰©ä½™ç©ºé—´) -->
                                            <template v-if="pot.last_care_action">
                                                <span class="text-gray-300 mx-1.5 shrink-0">|</span>
                                                <span class="text-gray-600 font-bold truncate">
                                                    {{ pot.last_care_action }}
                                                </span>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                                <div v-if="!isEditMode" class="text-gray-300">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- åº•éƒ¨æ‚¬æµ®æ“ä½œæ  -->
        <div v-if="pots.length > 0" class="fixed bottom-6 left-0 right-0 z-40 px-6 pointer-events-none">
            <div class="container mx-auto flex justify-center pointer-events-auto">
                <button v-if="isEditMode && selectedCount > 0" @click="deleteSelectedPots"
                    class="bg-red-500 text-white px-8 py-4 rounded-3xl shadow-xl shadow-red-200 flex items-center gap-2 font-bold transition-all active:scale-95 animate-slide-up">
                    <i class="fas fa-trash-alt"></i>
                    <span>åˆ é™¤é€‰ä¸­ ({{ selectedCount }})</span>
                </button>
                <button v-else-if="!isEditMode" @click="goAddPot"
                    class="bg-green-500 text-white px-8 py-4 rounded-3xl shadow-xl shadow-green-200 flex items-center gap-2 font-bold transition-all active:scale-95">
                    <i class="fas fa-plus"></i>
                    <span>æ·»åŠ èŠ±ç›†</span>
                </button>
            </div>
        </div>

        <!-- ç™»å½•/æ³¨å†Œ å¼¹çª— -->
        <div v-if="showLoginModal || showRegisterModal || showForgotPasswordModal"
            class="fixed inset-0 z-[60] flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="closeAuthModals"></div>
            <div class="relative bg-white w-full max-sm rounded-3xl shadow-2xl overflow-hidden animate-slide-up">
                <!-- ç™»å½•å¼¹çª— -->
                <div v-if="showLoginModal" class="p-8">
                    <!-- å…³é—­æŒ‰é’® -->
                    <button @click="closeAuthModals"
                        class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>

                    <h3 class="text-2xl font-black text-gray-800 mb-2">æ¬¢è¿å›æ¥</h3>
                    <p class="text-gray-400 text-sm mb-8">ç™»å½•ä»¥åŒæ­¥æ‚¨çš„èŠ±ç›†æ•°æ®</p>
                    <form @submit.prevent="handleLogin" class="space-y-4">
                        <input type="email" v-model="loginForm.email" placeholder="ç”µå­é‚®ç®±" required
                            class="w-full bg-gray-50 border-gray-100 rounded-2xl py-3 px-4 focus:ring-green-500">
                        <input type="password" v-model="loginForm.password" placeholder="å¯†ç " required
                            class="w-full bg-gray-50 border-gray-100 rounded-2xl py-3 px-4 focus:ring-green-500">
                        <button type="submit" :disabled="isAuthLoading"
                            class="w-full btn btn-primary py-4 rounded-2xl text-lg font-bold mt-4 shadow-lg shadow-green-100 disabled:opacity-50">
                            {{ isAuthLoading ? 'ç™»å½•ä¸­...' : 'ç«‹å³ç™»å½•' }}
                        </button>
                    </form>
                    <div class="mt-4 text-right">
                        <button @click="switchToForgotPassword"
                            class="text-xs text-gray-400 hover:text-green-500 transition">å¿˜è®°å¯†ç ï¼Ÿ</button>
                    </div>
                    <div class="mt-8 pt-6 border-t border-gray-50 text-center">
                        <span class="text-gray-400 text-sm">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span>
                        <button @click="switchToRegister" class="text-green-500 text-sm font-bold ml-1">æ³¨å†Œä¸€ä¸ª</button>
                    </div>
                </div>

                <!-- æ³¨å†Œå¼¹çª— -->
                <div v-if="showRegisterModal" class="p-8">
                    <!-- å…³é—­æŒ‰é’® -->
                    <button @click="closeAuthModals"
                        class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>

                    <h3 class="text-2xl font-black text-gray-800 mb-2">åˆ›å»ºè´¦å·</h3>
                    <p class="text-gray-400 text-sm mb-8">å¼€å§‹æ‚¨çš„æ™ºèƒ½å…»èŠ±ä¹‹æ—…</p>
                    <form @submit.prevent="handleRegister" class="space-y-4">
                        <input type="email" v-model="registerForm.email" placeholder="ç”µå­é‚®ç®±" required
                            class="w-full bg-gray-50 border-gray-100 rounded-2xl py-3 px-4">
                        <input type="text" v-model="registerForm.displayName" placeholder="æ˜µç§°"
                            class="w-full bg-gray-50 border-gray-100 rounded-2xl py-3 px-4">
                        <input type="password" v-model="registerForm.password" placeholder="å¯†ç  (è‡³å°‘8ä½)" required
                            class="w-full bg-gray-50 border-gray-100 rounded-2xl py-3 px-4">
                        <div class="relative">
                            <input type="password" v-model="registerForm.confirmPassword" placeholder="ç¡®è®¤å¯†ç " required
                                class="w-full bg-gray-50 border-gray-100 rounded-2xl py-3 px-4">
                            <div v-if="registerForm.password && registerForm.confirmPassword"
                                class="absolute right-3 top-1/2 transform -translate-y-1/2">
                                <i v-if="passwordsMatch" class="fas fa-check text-green-500"></i>
                                <i v-else class="fas fa-times text-red-500"></i>
                            </div>
                        </div>
                        <!-- ä¿®å¤ï¼šåªåœ¨å¯†ç ä¸ä¸€è‡´ä¸”ä¸¤ä¸ªå¯†ç æ¡†éƒ½æœ‰å†…å®¹æ—¶æ˜¾ç¤ºé”™è¯¯æç¤º -->
                        <div v-if="registerForm.password && registerForm.confirmPassword && !passwordsMatch"
                            class="text-red-500 text-sm mt-1 px-2">
                            ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´
                        </div>
                        <button type="submit" :disabled="!isRegisterValid || isAuthLoading"
                            class="w-full btn btn-primary py-4 rounded-2xl text-lg font-bold mt-4 disabled:opacity-50">
                            {{ isAuthLoading ? 'æ³¨å†Œå¹¶åˆå¹¶æ•°æ®' : 'å®Œæˆæ³¨å†Œ' }}
                        </button>
                    </form>
                    <div class="mt-8 pt-6 border-t border-gray-50 text-center">
                        <span class="text-gray-400 text-sm">å·²æœ‰è´¦å·ï¼Ÿ</span>
                        <button @click="switchToLogin" class="text-green-500 text-sm font-bold ml-1">å»ç™»å½•</button>
                    </div>
                </div>

                <!-- å¿˜è®°å¯†ç å¼¹çª— -->
                <div v-if="showForgotPasswordModal" class="p-8">
                    <!-- å…³é—­æŒ‰é’® -->
                    <button @click="closeAuthModals"
                        class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>

                    <h3 class="text-2xl font-black text-gray-800 mb-2">é‡ç½®æ‚¨çš„å¯†ç </h3>
                    <p class="text-gray-400 text-sm mb-8">æˆ‘ä»¬å°†å‘æ‚¨çš„é‚®ç®±å‘é€é‡ç½®é“¾æ¥</p>
                    <form @submit.prevent="handleForgotPassword" class="space-y-4">
                        <input type="email" v-model="loginForm.email" placeholder="ç”µå­é‚®ç®±" required
                            class="w-full bg-gray-50 border-gray-100 rounded-2xl py-3 px-4 focus:ring-green-500">
                        <p v-if="loginForm.email && !isForgotPasswordEmailValid" class="text-red-500 text-xs px-4">
                            è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±åœ°å€
                        </p>
                        <button type="submit" :disabled="isAuthLoading || !isForgotPasswordEmailValid"
                            class="w-full btn btn-primary py-4 rounded-2xl text-lg font-bold mt-4 shadow-lg shadow-green-100 disabled:opacity-50">
                            {{ isAuthLoading ? 'å‘é€ä¸­...' : 'å‘é€é‡ç½®é‚®ä»¶' }}
                        </button>
                    </form>
                    <div class="mt-8 pt-6 border-t border-gray-50 text-center">
                        <button @click="switchToLogin" class="text-green-500 text-sm font-bold">è¿”å›ç™»å½•</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, computed, nextTick, watch } = Vue;

        createApp({
            setup() {
                const isLoading = ref(true);
                const pots = ref([]);
                const user = ref(null);
                const isLoggedIn = ref(false);
                const userDisplayName = computed(() => {
                    // åŒ¿åç”¨æˆ·
                    if (user.value?.userType === 'anonymous') return 'åŒ¿åç”¨æˆ·';
                    // æ­£å¼ç”¨æˆ·å·²ç™»å½•
                    if (isLoggedIn.value && user.value) {
                        return user.value.displayName || user.value.email?.split('@')[0] || 'ç”¨æˆ·';
                    }
                    // æœªç™»å½•
                    return 'æœªç™»å½•';
                });
                const weatherData = ref(null);
                const careAdvice = ref([]);
                const careReminders = ref([]); // ä»Šæ—¥å¾…å…»æŠ¤
                const showRemindersExpanded = ref(false); // é»˜è®¤æŠ˜å 
                const currentAdviceIndex = ref(0);
                const isEditMode = ref(false); // ç»Ÿä¸€ç®¡ç†æ¨¡å¼
                const potsGrid = ref(null);    // åˆ—è¡¨å®¹å™¨Ref
                let sortableInstance = null;   // Sortableå®ä¾‹
                const showUserMenu = ref(false);
                const showLoginModal = ref(false);
                const showRegisterModal = ref(false);
                const showForgotPasswordModal = ref(false);
                const isAuthLoading = ref(false);
                const loginForm = reactive({ email: '', password: '' });
                const registerForm = reactive({
                    email: '',
                    password: '',
                    confirmPassword: '',
                    displayName: ''
                });

                const passwordsMatch = computed(() =>
                    registerForm.password === registerForm.confirmPassword
                );

                const isForgotPasswordEmailValid = computed(() => {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    return emailRegex.test(loginForm.email);
                });

                const isRegisterValid = computed(() =>
                    registerForm.email &&
                    registerForm.password.length >= 8 &&
                    passwordsMatch.value
                );

                const allSelected = computed(() => pots.value.length > 0 && pots.value.every(p => p.selected));
                const selectedCount = computed(() => pots.value.filter(p => p.selected).length);

                const init = async () => {
                    // å…¨å±€ç‚¹å‡»äº‹ä»¶ï¼šç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸæ—¶å…³é—­ä¸‹æ‹‰èœå•
                    document.addEventListener('click', (e) => {
                        // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯ç”¨æˆ·èœå•åŒºåŸŸï¼Œåˆ™å…³é—­èœå•
                        const userMenuArea = document.querySelector('.user-menu-container');
                        if (userMenuArea && !userMenuArea.contains(e.target)) {
                            showUserMenu.value = false;
                        }
                    });

                    checkLoginStatus();
                    await fetchPots();
                    loadWeather();
                    startAdviceTimer();
                };

                const checkLoginStatus = () => {
                    const token = localStorage.getItem('flowerpots_token');
                    if (token) {
                        isLoggedIn.value = true;
                        apiClient.getCurrentUser().then(res => {
                            if (res.success) user.value = res.user;
                        }).catch(() => { });
                    }
                };

                const fetchPots = async () => {
                    try {
                        isLoading.value = true;
                        // ä¸åœ¨åˆå§‹åŒ–æ—¶è‡ªåŠ¨ identify
                        const res = await apiClient.getPots();
                        if (res.success) {
                            pots.value = res.data.map(p => ({ ...p, selected: false, swipeX: 0, startX: 0 }));
                        }
                        // åŒæ—¶åŠ è½½ä»Šæ—¥å¾…å…»æŠ¤
                        loadCareReminders();
                    } catch (e) { } finally { isLoading.value = false; }
                };

                const loadCareReminders = async () => {
                    try {
                        const res = await apiClient.getCareReminders();
                        if (res.success) {
                            careReminders.value = res.data || [];
                        }
                    } catch (e) {
                        console.warn('åŠ è½½å…»æŠ¤æé†’å¤±è´¥:', e);
                    }
                };

                const goToPotDetail = (potId) => {
                    window.location.href = `pot-detail.html?id=${potId}`;
                };

                const handleLogin = async () => {
                    try {
                        isAuthLoading.value = true;
                        const res = await apiClient.login(loginForm.email, loginForm.password);
                        if (res.token) location.reload();
                    } catch (e) { alert('ç™»å½•å¤±è´¥: ' + e.message); } finally { isAuthLoading.value = false; }
                };

                const handleForgotPassword = async () => {
                    if (!loginForm.email) {
                        alert('è¯·è¾“å…¥æ‚¨çš„ç”µå­é‚®ç®±');
                        return;
                    }
                    try {
                        isAuthLoading.value = true;
                        const res = await apiClient.forgotPassword(loginForm.email);
                        if (res.success) {
                            alert('é‡ç½®é“¾æ¥å·²å‘é€åˆ°æ‚¨çš„é‚®ç®±ï¼Œè¯·æ£€æŸ¥ï¼ˆåŒ…æ‹¬åƒåœ¾ç®±ï¼‰ã€‚');
                            showForgotPasswordModal.value = false;
                        }
                    } catch (e) {
                        alert('å‘é€å¤±è´¥: ' + e.message);
                    } finally {
                        isAuthLoading.value = false;
                    }
                };

                const handleRegister = async () => {
                    // å‰ç«¯éªŒè¯ï¼šæ£€æŸ¥å¯†ç æ˜¯å¦ä¸€è‡´
                    if (!passwordsMatch.value) {
                        alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼Œè¯·é‡æ–°è¾“å…¥');
                        return;
                    }

                    // å‰ç«¯éªŒè¯ï¼šæ£€æŸ¥å¯†ç é•¿åº¦
                    if (registerForm.password.length < 8) {
                        alert('å¯†ç é•¿åº¦è‡³å°‘éœ€è¦8ä½');
                        return;
                    }

                    try {
                        isAuthLoading.value = true;
                        const anonymousUserId = localStorage.getItem('flowerpots_user_id');
                        const isAnonymous = !user.value || user.value.userType === 'anonymous';

                        let res;
                        if (isAnonymous && anonymousUserId) {
                            res = await apiClient.upgrade(registerForm.email, registerForm.password, registerForm.displayName, anonymousUserId);
                        } else {
                            res = await apiClient.register(registerForm.email, registerForm.password, registerForm.displayName);
                        }

                        if (res.success || res.token) {
                            alert(isAnonymous ? 'æ³¨å†ŒæˆåŠŸï¼Œæ‚¨çš„åŒ¿åæ•°æ®å·²åˆå¹¶ï¼' : 'æ³¨å†ŒæˆåŠŸï¼');
                            location.reload();
                        }
                    } catch (e) {
                        alert('æ³¨å†Œå¤±è´¥: ' + e.message);
                    } finally {
                        isAuthLoading.value = false;
                    }
                };

                const toggleSelectAll = () => {
                    const target = !allSelected.value;
                    pots.value.forEach(p => p.selected = target);
                };

                // åˆ‡æ¢ç®¡ç†æ¨¡å¼
                const toggleEditMode = async () => {
                    isEditMode.value = !isEditMode.value;
                    if (isEditMode.value) {
                        await nextTick();
                        initSortable();
                    } else {
                        pots.value.forEach(p => p.selected = false);
                        destroySortable();
                    }
                };

                const initSortable = () => {
                    if (!potsGrid.value) return;
                    sortableInstance = new Sortable(potsGrid.value, {
                        animation: 300, // ç¨å¾®è°ƒæ…¢åŠ¨ç”»ï¼Œæ›´å¹³æ»‘
                        handle: '.handle',
                        delay: 0,
                        forceFallback: true, // å…³é”®ï¼šä½¿ç”¨fallback
                        fallbackClass: 'sortable-fallback',
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        dragClass: 'sortable-drag',
                        scroll: true,
                        scrollSensitivity: 50, // å¢åŠ æ»šåŠ¨æ•æ„ŸåŒºåŸŸ
                        scrollSpeed: 20,
                        bubbleScroll: true,
                        fallbackTolerance: 3, // é˜²æ­¢è¯¯è§¦
                        // å…³é”®ä¿®æ”¹ï¼šç¦ç”¨GPUåŠ é€Ÿï¼Œè¿«ä½¿Sortableä½¿ç”¨top/leftå®šä½ï¼Œ
                        // ä»è€Œå…è®¸æˆ‘ä»¬ä½¿ç”¨CSS transform: scale() æ¥åˆ¶ä½œâ€œæµ®èµ·â€æ•ˆæœ
                        // å¦‚æœå¼€å¯GPUåŠ é€Ÿï¼ŒSortableä¼šè¦†ç›–transformå±æ€§
                        gpuAcceleration: false,
                        onChoose: () => {
                            if (navigator.vibrate) navigator.vibrate(50);
                        },
                        onUnchoose: () => {
                            if (navigator.vibrate) navigator.vibrate(30);
                        },
                        onEnd: async (evt) => {
                            const item = pots.value.splice(evt.oldIndex, 1)[0];
                            pots.value.splice(evt.newIndex, 0, item);
                            try {
                                await apiClient.reorderPots(pots.value.map(p => p.id));
                            } catch (e) { console.error(e); }
                        }
                    });
                };

                const destroySortable = () => {
                    if (sortableInstance) {
                        sortableInstance.destroy();
                        sortableInstance = null;
                    }
                };

                // ç§»é™¤åŸæœ‰çš„ isBatchMode ç›‘å¬

                // ä¾§æ»‘é€»è¾‘
                const handleTouchStart = (pot, e) => { if (!isEditMode.value) { pot.startX = e.touches[0].clientX; pots.value.forEach(p => { if (p !== pot) p.swipeX = 0; }); } };
                const handleTouchMove = (pot, e) => { if (!isEditMode.value) { const dx = e.touches[0].clientX - pot.startX; if (dx < 0) pot.swipeX = Math.max(dx, -128); else if (pot.swipeX < 0) pot.swipeX = Math.min(0, -128 + dx); } };
                const handleTouchEnd = (pot) => { if (!isEditMode.value) pot.swipeX = pot.swipeX < -64 ? -128 : 0; };
                const handleCardClick = (pot) => { if (pot.swipeX < 0) pot.swipeX = 0; else if (!isEditMode.value) window.location.href = `pot-detail.html?id=${pot.id}`; };

                const deleteSelectedPots = async () => {
                    const toDelete = pots.value.filter(p => p.selected);
                    if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${toDelete.length} ä¸ªèŠ±ç›†å—ï¼Ÿ`)) {
                        try {
                            isLoading.value = true;
                            for (const p of toDelete) await apiClient.deletePot(p.id);
                            await fetchPots();
                            isEditMode.value = false;
                        } catch (e) { alert('åˆ é™¤å¤±è´¥'); } finally { isLoading.value = false; }
                    }
                };

                const confirmDeleteSingle = async (id) => { if (confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ')) { await apiClient.deletePot(id); await fetchPots(); } };
                const logout = async () => { await apiClient.logout(); location.reload(); };
                const closeAuthModals = () => {
                    showLoginModal.value = false;
                    showRegisterModal.value = false;
                    showForgotPasswordModal.value = false;
                };
                const switchToRegister = () => {
                    showLoginModal.value = false;
                    showRegisterModal.value = true;
                    showForgotPasswordModal.value = false;
                };
                const switchToLogin = () => {
                    showRegisterModal.value = false;
                    showLoginModal.value = true;
                    showForgotPasswordModal.value = false;
                };

                const seedDemoData = async () => {
                    try {
                        isAuthLoading.value = true;
                        const res = await apiClient.seedDemoData();
                        if (res.success) {
                            // æ›´æ–°ç”¨æˆ·çŠ¶æ€ä¸ºåŒ¿åç”¨æˆ·
                            user.value = { userType: 'anonymous' };
                            isLoggedIn.value = true;
                            await fetchPots();
                            if (navigator.vibrate) navigator.vibrate(50);
                        }
                    } catch (e) {
                        alert('ç”Ÿæˆå¤±è´¥: ' + e.message);
                    } finally {
                        isAuthLoading.value = false;
                    }
                };

                const switchToForgotPassword = () => {
                    showLoginModal.value = false;
                    showForgotPasswordModal.value = true;
                };
                const loadWeather = async () => { try { const res = await apiClient.getWeather(); if (res.success) { weatherData.value = res.data; if (pots.value.length > 0) { const aRes = await apiClient.getCareAdvice({ weather: res.data, pots: pots.value }); if (aRes.success) careAdvice.value = aRes.data; } } } catch (e) { } };
                const startAdviceTimer = () => setInterval(() => { if (careAdvice.value.length > 0) currentAdviceIndex.value = (currentAdviceIndex.value + 1) % careAdvice.value.length; }, 5000);
                const formatDate = (d) => {
                    if (!d) return '';
                    const date = new Date(d);
                    if (isNaN(date.getTime())) return ''; // å¤„ç†éæ³•æ—¥æœŸ
                    return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
                };
                const handleImageError = (e) => e.target.src = 'assets/images/icons/icons-default-pot.png';

                onMounted(init);

                return {
                    isLoading, pots, user, isLoggedIn, userDisplayName, weatherData, careAdvice, careReminders, showRemindersExpanded, currentAdviceIndex,
                    isEditMode, potsGrid, showUserMenu, showLoginModal, showRegisterModal, showForgotPasswordModal, isAuthLoading,
                    loginForm, registerForm, passwordsMatch, isRegisterValid, isForgotPasswordEmailValid, allSelected, selectedCount,
                    handleLogin, handleRegister, handleForgotPassword, toggleSelectAll, toggleEditMode, deleteSelectedPots,
                    handleTouchStart, handleTouchMove, handleTouchEnd, handleCardClick, confirmDeleteSingle,
                    logout, closeAuthModals, switchToRegister, switchToLogin, switchToForgotPassword,
                    formatDate, handleImageError, seedDemoData, goToPotDetail,
                    goEditPot: (id) => window.location.href = `edit-pot.html?id=${id}`,
                    goAddPot: () => window.location.href = 'add-pot.html',
                    goProfile: () => window.location.href = 'profile.html',
                    goAdmin: () => window.location.href = 'admin-plants.html'
                };
            }
        }).mount('#app');
    </script>

    <style>
        [v-cloak] {
            display: none;
        }

        .header {
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .animate-slide-up {
            animation: slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .animate-fade-in {
            animation: fade-in 0.2s ease-out;
        }

        @keyframes slide-up {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fade-in {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .btn-primary {
            background: #10b981;
            color: #fff;
            font-weight: 800;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* æ’åºç›¸å…³æ ·å¼ */
        .sortable-ghost {
            opacity: 0;
            /* è®©åŸä½ç½®å®Œå…¨é€æ˜ï¼Œå½¢æˆâ€œç©ºæ´â€æ„Ÿ */
        }

        .sortable-fallback {
            opacity: 1 !important;
            background: #fff;
            /* åŠ å…¥æ—‹è½¬å’Œæ”¾å¤§ï¼Œæ¨¡æ‹Ÿâ€œæ‹¿èµ·â€çš„æ•ˆæœ */
            transform: scale(1.05) rotate(2deg);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border-radius: 1.5rem;
            /* rounded-3xl */
            z-index: 9999 !important;
            pointer-events: none;
            /* ç¡®ä¿ä¸é˜»æŒ¡åº•å±‚äº‹ä»¶ */
            cursor: grabbing;
        }

        .sortable-drag {
            cursor: grabbing;
            opacity: 0;
            /* éšè—åŸç”Ÿæ‹–æ‹½å½±åƒ */
        }
    </style>
</body>

</html>