<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ëä±ÁõÜËØ¶ÊÉÖ - My Flower Pots</title>

    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <!-- Tailwind CSS & Custom Styles (Optimized) -->
    <link rel="stylesheet" href="css/tailwind-built.css">

    <!-- ÂõæÊ†áÂ∫ì -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Ëá™ÂÆö‰πâËÑöÊú¨ -->
    <script src="js/config.js?v=20260111"></script>
    <script src="js/api-client.js?v=20260111"></script>
</head>

<body class="bg-gray-50">
    <div id="app" v-cloak>
        <!-- È°∂ÈÉ®ÂØºËà™Ê†è (Âº∫Âà∂Èù†Â∑¶+Â±Ö‰∏≠) -->
        <header class="header bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-gray-50 h-16 w-full">
            <div class="relative flex items-center h-full px-4">
                <!-- Â∑¶‰æßÊåâÈíÆ -->
                <div class="z-10">
                    <button class="w-10 h-10 flex items-center justify-center text-gray-400 active:scale-90 transition"
                        @click="goBack">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </button>
                </div>
                <!-- Â±Ö‰∏≠Ê†áÈ¢ò -->
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <h1 class="text-base sm:text-lg font-black text-gray-800">Ëä±ÁõÜËØ¶ÊÉÖ</h1>
                </div>
            </div>
        </header>

        <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü -->
        <main class="main pb-20">
            <!-- È™®Êû∂Â±èÂä†ËΩΩÁä∂ÊÄÅ (Skeleton Screen) -->
            <div v-if="isLoading" class="container mx-auto px-4 py-6 space-y-6 animate-pulse">
                <!-- 1. Ëä±ÁõÜÂç°ÁâáÈ™®Êû∂ -->
                <div class="bg-gray-200 rounded-3xl h-64 md:h-80 w-full shadow-sm"></div>

                <!-- 2. ‰ø°ÊÅØÂç°ÁâáÈ™®Êû∂ -->
                <div class="bg-gray-200 rounded-3xl h-48 w-full shadow-sm border border-gray-100"></div>

                <!-- 3. ÂÖªÊä§ÁªüËÆ°/ÂàóË°®È™®Êû∂ -->
                <div class="bg-gray-200 rounded-3xl h-40 w-full shadow-sm"></div>

                <!-- 4. ÂàóË°®Êù°ÁõÆÈ™®Êû∂ (ÈáçÂ§ç) -->
                <div class="space-y-4">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-full bg-gray-200 shrink-0"></div>
                        <div class="flex-1 space-y-2">
                            <div class="h-4 bg-gray-200 rounded w-1/3"></div>
                            <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-full bg-gray-200 shrink-0"></div>
                        <div class="flex-1 space-y-2">
                            <div class="h-4 bg-gray-200 rounded w-1/3"></div>
                            <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÈîôËØØÊèêÁ§∫ -->
            <div v-if="error" class="error-alert container mx-auto px-4 mt-4">
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span>{{ error }}</span>
                    <button @click="error = null" class="absolute top-0 bottom-0 right-0 px-4">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- ÂÜÖÂÆπÂå∫Âüü -->
            <div v-if="!isLoading && pot" class="container mx-auto px-4 py-6 space-y-6">
                <!-- 1. Ëä±ÁõÜÂü∫Êú¨‰ø°ÊÅØÂç°Áâá -->
                <div class="bg-white rounded-3xl shadow-sm overflow-hidden border border-gray-50">
                    <div class="relative h-64 md:h-80">
                        <img :src="pot.image_url || 'assets/images/icons/icons-default-pot.png'"
                            class="w-full h-full object-cover" @error="handleImageError">
                        <div
                            class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-6 text-white">
                            <h2 class="text-2xl font-black">{{ pot.name }}</h2>
                            <!-- <div class="flex items-center gap-2 mt-1">
                                <span
                                    class="bg-white/20 backdrop-blur-md px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider">{{
                                    pot.plant_type || 'ÊôÆÈÄöÊ§çÁâ©' }}</span>
                                <span class="text-xs opacity-80">ÁßçÊ§ç‰∫é {{ formatDate(pot.plant_date) }}</span>
                            </div> -->
                        </div>
                        <!-- ÁºñËæëÂÖ•Âè£ -->
                        <button @click="goEditPage"
                            class="absolute top-4 right-4 w-10 h-10 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-white active:scale-90 transition">
                            <i class="fas fa-pen text-sm"></i>
                        </button>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="flex flex-col gap-2 text-sm">
                            <div class="flex items-baseline gap-2">
                                <span class="text-gray-900 font-bold shrink-0 w-20">ÁßçÊ§çÊó•ÊúüÔºö</span>
                                <span class="text-gray-600">{{ formatDate(pot.plant_date) }}</span>
                            </div>
                            <div class="flex items-baseline gap-2">
                                <span class="text-gray-900 font-bold shrink-0 w-20">Ëä±ÁõÜÂ§áÊ≥®Ôºö</span>
                                <span class="text-gray-600">{{ pot.note || 'Êó†' }}</span>
                            </div>
                            <div v-if="matchedPlantName" class="flex items-baseline gap-2">
                                <span class="text-gray-900 font-bold shrink-0 w-20">ÂåπÈÖçÊ§çÁâ©Ôºö</span>
                                <span class="text-gray-600 font-bold text-green-600">{{ matchedPlantName }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ê§çÁâ©Âü∫Êú¨‰ø°ÊÅØ (Basic Info Section - Optimized) -->
                <div v-if="plantInfo" class="bg-white rounded-3xl shadow-sm p-6 border border-gray-50">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-black text-gray-800 flex items-center gap-2">
                            <i class="fas fa-book text-green-500"></i> Âü∫Êú¨‰ø°ÊÅØ
                        </h3>
                    </div>

                    <div class="space-y-3.5 text-sm overflow-hidden transition-all duration-500"
                        :style="{ maxHeight: showFullPlantInfo ? '1000px' : '300px' }">
                        <!-- ‰ºòÂÖàÊòæÁ§∫ -->
                        <div v-for="item in plantInfoGroups.priority" :key="item.key" class="flex gap-2">
                            <span class="text-gray-900 font-bold shrink-0 w-20 whitespace-nowrap">{{ item.label
                                }}Ôºö</span>
                            <span class="text-gray-600 flex-1">{{ item.val }}</span>
                        </div>

                        <!-- ÊäòÂè†ÊòæÁ§∫È°π -->
                        <div v-if="showFullPlantInfo" v-for="item in plantInfoGroups.extended" :key="item.key"
                            class="flex gap-2 animate-fade-in">
                            <span class="text-gray-900 font-bold shrink-0 w-20 whitespace-nowrap">{{ item.label
                                }}Ôºö</span>
                            <span class="text-gray-600 flex-1">{{ item.val }}</span>
                        </div>
                    </div>

                    <!-- Â±ïÂºÄ/Êî∂Ëµ∑ÊåâÈíÆ (Âü∫Êú¨‰ø°ÊÅØ) -->
                    <div v-if="plantInfoGroups.extended.length > 0"
                        class="mt-4 flex justify-center border-t border-gray-50 pt-4">
                        <button @click="showFullPlantInfo = !showFullPlantInfo"
                            class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 hover:text-green-500 hover:bg-green-50 transition active:scale-90">
                            <i class="fas" :class="showFullPlantInfo ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </button>
                    </div>
                </div>

                <!-- 2. ÂÖªÊä§ÊèêÁ§∫ (Care Tips Section - Optimized) -->
                <div v-if="plantInfo" class="bg-white rounded-3xl shadow-sm border border-gray-50 overflow-hidden">
                    <div class="px-6 py-5 bg-gray-50/30 border-b border-gray-50">
                        <h3 class="text-lg font-black text-blue-500 flex items-center gap-2">
                            <span>üí°</span> ÂÖªÊä§ÊèêÁ§∫
                        </h3>
                    </div>

                    <div class="px-6 py-6 overflow-hidden transition-all duration-500"
                        :style="{ maxHeight: showFullCareTips ? '3000px' : '650px' }">

                        <!-- 1. È°∂ÈÉ®ÊÄªÁªìÊ®™Á∫ø (Summary Line - Simple with Pipe Separator) -->
                        <div
                            class="flex flex-wrap items-center justify-center gap-x-2 gap-y-2 mb-8 text-[11px] font-bold text-gray-500 px-4">
                            <template v-for="(item, idx) in careTipsGroups.summary" :key="item.key">
                                <span class="whitespace-nowrap">{{ item.label }}Ôºö<span
                                        class="text-blue-500 font-black">{{ item.val }}</span></span>
                                <span v-if="idx < careTipsGroups.summary.length - 1" class="text-gray-300 mx-1">|</span>
                            </template>
                        </div>

                        <!-- 2. Êó•ÂøóËØ¶ÊÉÖÂàóË°® (Log Style) -->
                        <div class="space-y-8">
                            <div v-for="item in careTipsGroups.priorityDetails" :key="item.key"
                                class="relative pl-6 border-l-2 border-blue-100/50">
                                <!-- Â∑¶‰æßË£ÖÈ•∞ÂéüÁÇπ -->
                                <div
                                    class="absolute -left-[5px] top-0 w-2 h-2 rounded-full bg-blue-400 shadow-[0_0_10px_rgba(59,130,246,0.3)]">
                                </div>

                                <div class="space-y-2">
                                    <div class="flex items-center gap-2">
                                        <i :class="item.icon" class="text-blue-500 text-sm"></i>
                                        <span class="text-xs font-black text-gray-800 uppercase tracking-widest">{{
                                            item.label }}</span>
                                    </div>
                                    <p class="text-sm text-gray-600 leading-relaxed font-medium">{{ item.val }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- 3. ÊäòÂè†Êâ©Â±ïÈÉ®ÂàÜ -->
                        <div v-if="showFullCareTips"
                            class="mt-8 pt-8 border-t border-gray-50 space-y-8 animate-fade-in">
                            <div v-for="item in careTipsGroups.extended" :key="item.key"
                                class="relative pl-6 border-l-2 border-gray-100">
                                <div class="absolute -left-[5px] top-0 w-2 h-2 rounded-full bg-gray-300"></div>

                                <div class="space-y-2">
                                    <div class="flex items-center gap-2">
                                        <i :class="item.icon" class="text-gray-400 text-sm"></i>
                                        <span class="text-xs font-black text-gray-500 uppercase tracking-widest">{{
                                            item.label }}</span>
                                    </div>
                                    <p class="text-sm text-gray-600 leading-relaxed font-medium">{{ item.val }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Â±ïÂºÄ/Êî∂Ëµ∑ÊåâÈíÆ (ÂÖªÊä§ÊèêÁ§∫) -->
                    <div v-if="careTipsGroups.extended.length > 0" class="pb-6 flex justify-center">
                        <button @click="showFullCareTips = !showFullCareTips"
                            class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 hover:text-blue-500 hover:bg-blue-50 transition active:scale-90 shadow-sm border border-gray-100">
                            <i class="fas" :class="showFullCareTips ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </button>
                    </div>
                </div>
                <!-- ÁßªÈô§ËøáÊó©ÂÖ≥Èó≠ÁöÑÂÆπÂô® div -->

                <!-- 3.5 ÂÖªÊä§Âë®ÊúüËÆæÁΩÆ (Care Schedules) - Â¢ûÂº∫Áâà -->
                <div class="bg-white rounded-3xl shadow-sm border border-gray-50 overflow-hidden">
                    <!-- Â§¥ÈÉ®ÔºöÁÇπÂáªÊäòÂè† -->
                    <div @click="showScheduleExpanded = !showScheduleExpanded"
                        class="p-6 flex justify-between items-center border-b border-gray-50 cursor-pointer active:bg-gray-50 transition">
                        <h3 class="text-lg font-black text-gray-800 flex items-center gap-2">
                            <i class="fas fa-clock text-purple-400"></i> ÂÖªÊä§ÊèêÈÜí
                            <i class="fas text-[10px] ml-1 text-gray-300 transition-transform duration-300"
                                :class="showScheduleExpanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </h3>
                        <!-- ‰ªÖÂ±ïÂºÄÊó∂ÊòæÁ§∫Ê∑ªÂä†ÊåâÈíÆÔºåÊäòÂè†Êó∂ÊòæÁ§∫ÊëòË¶Å -->
                        <div v-if="showScheduleExpanded">
                            <button @click.stop="showAddScheduleModal = true"
                                class="text-xs font-bold text-purple-500 bg-purple-50 px-3 py-1.5 rounded-full active:scale-95 transition">
                                <i class="fas fa-plus mr-1"></i> Ê∑ªÂä†
                            </button>
                        </div>
                        <div v-else class="text-xs font-bold text-gray-400">
                            {{ careSchedules.filter(s => s.enabled).length }} È°πÂêØÁî®
                        </div>
                    </div>

                    <!-- ÂÜÖÂÆπÂå∫ÂüüÔºöÈªòËÆ§Â±ïÂºÄ -->
                    <div v-show="showScheduleExpanded" class="p-6 space-y-4 animate-fade-in">
                        <!-- Â∑≤ËÆæÁΩÆÁöÑÂë®ÊúüÂàóË°® -->
                        <template v-for="schedule in careSchedules" :key="schedule.id">
                            <div class="flex items-center justify-between gap-3 p-3 bg-gray-50/50 rounded-2xl">
                                <!-- Â∑¶‰æßÔºöÁ±ªÂûãÂõæÊ†áÂíåÂêçÁß∞ -->
                                <div class="flex items-center gap-3 min-w-0">
                                    <div class="w-10 h-10 rounded-2xl flex items-center justify-center text-lg shrink-0"
                                        :class="getScheduleTypeStyle(schedule.care_type).bg">
                                        {{ getScheduleTypeStyle(schedule.care_type).icon }}
                                    </div>
                                    <div class="min-w-0">
                                        <div class="text-sm font-bold text-gray-800">
                                            {{ schedule.custom_action || getScheduleTypeName(schedule.care_type) }}
                                        </div>
                                        <!-- ÂÜÖËÅîÁºñËæëÂë®Êúü -->
                                        <div class="flex items-center gap-1 mt-0.5" @click.stop>
                                            <span class="text-[10px] text-gray-400">ÊØè</span>
                                            <input type="number" v-model.lazy.number="schedule.intervalDays"
                                                class="w-8 h-5 text-center text-[10px] font-bold bg-white border border-gray-200 rounded px-0 py-0 focus:ring-1 focus:ring-purple-200"
                                                @change="updateScheduleInterval(schedule)">
                                            <span class="text-[10px] text-gray-400">Â§©ÊèêÈÜí</span>
                                        </div>
                                        <div v-if="getScheduleHint(schedule.care_type)"
                                            class="text-[10px] text-gray-400 mt-1 flex items-center gap-1">
                                            <i class="fas fa-info-circle text-blue-400"></i>
                                            <span>{{ getScheduleHint(schedule.care_type) }}</span>
                                        </div>

                                        <!-- Â≠£ËäÇÊÄßË¥¥Â£´ (New) -->
                                        <div v-if="getSeasonalTip(schedule.care_type)"
                                            class="mt-1.5 flex items-start text-[10px] bg-opacity-10 rounded px-2 py-1 max-w-[200px]"
                                            :class="{
                                                'bg-blue-100 text-blue-600': ['Winter', 'Summer'].includes(getSeasonalTip(schedule.care_type).season),
                                                'bg-green-100 text-green-600': getSeasonalTip(schedule.care_type).season === 'Spring',
                                                'bg-orange-100 text-orange-600': getSeasonalTip(schedule.care_type).season === 'Autumn'
                                            }">
                                            <span class="mr-1.5 shrink-0">
                                                <i v-if="getSeasonalTip(schedule.care_type).season === 'Spring'"
                                                    class="fas fa-seedling"></i>
                                                <i v-else-if="getSeasonalTip(schedule.care_type).season === 'Summer'"
                                                    class="fas fa-sun"></i>
                                                <i v-else-if="getSeasonalTip(schedule.care_type).season === 'Autumn'"
                                                    class="fab fa-canadian-maple-leaf"></i>
                                                <i v-else class="far fa-snowflake"></i>
                                            </span>
                                            <div class="leading-tight">
                                                <span class="font-bold mr-1">{{
                                                    getSeasonalTip(schedule.care_type).season === 'Spring' ? 'Êò•Â≠£Ë¥¥Â£´:' :
                                                    (getSeasonalTip(schedule.care_type).season === 'Summer' ? 'Â§èÂ≠£Ë¥¥Â£´:' :
                                                    (getSeasonalTip(schedule.care_type).season === 'Autumn' ? 'ÁßãÂ≠£Ë¥¥Â£´:' :
                                                    'ÂÜ¨Â≠£Ë¥¥Â£´:'))
                                                    }}</span>
                                                <span>{{ getSeasonalTip(schedule.care_type).text }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Âè≥‰æßÔºöÂºÄÂÖ≥ÂíåÂà†Èô§ -->
                                <div class="flex items-center gap-2">
                                    <button @click="toggleScheduleEnabled(schedule)"
                                        class="w-12 h-7 rounded-full transition-all duration-300 relative"
                                        :class="schedule.enabled ? getScheduleTypeStyle(schedule.care_type).toggle : 'bg-gray-200'">
                                        <span
                                            class="absolute w-5 h-5 bg-white rounded-full top-1 transition-all duration-300 shadow-sm"
                                            :class="schedule.enabled ? 'right-1' : 'left-1'"></span>
                                    </button>
                                    <button @click="deleteSchedule(schedule)"
                                        class="w-8 h-8 rounded-xl text-gray-300 hover:text-red-400 hover:bg-red-50 transition">
                                        <i class="fas fa-trash-alt text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </template>

                        <!-- Á©∫Áä∂ÊÄÅ -->
                        <div v-if="careSchedules.length === 0" class="py-8 text-center">
                            <div class="text-3xl mb-2">‚è∞</div>
                            <p class="text-sm text-gray-400">ÊöÇÊú™ËÆæÁΩÆÂÖªÊä§ÊèêÈÜí</p>
                            <p class="text-xs text-gray-300 mt-1">ÁÇπÂáª‰∏äÊñπ"Ê∑ªÂä†"ÊåâÈíÆËÆæÁΩÆ</p>
                        </div>

                        <!-- ÊèêÁ§∫‰ø°ÊÅØ -->
                        <div v-if="careSchedules.length > 0" class="pt-2 text-center text-[10px] text-gray-400">
                            <i class="fas fa-info-circle mr-1"></i>
                            ÂêØÁî®ÂêéÂ∞ÜÂú®È¶ñÈ°µÊòæÁ§∫ÂæÖÂÖªÊä§ÊèêÈÜí
                        </div>
                    </div>
                </div>

                <!-- Ê∑ªÂä†ÂÖªÊä§Âë®ÊúüÂºπÁ™ó -->
                <teleport to="body">
                    <transition name="fade">
                        <div v-if="showAddScheduleModal"
                            class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center"
                            @click.self="showAddScheduleModal = false">
                            <div class="bg-white w-full max-w-lg rounded-t-3xl p-6 pb-10 animate-slide-up">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="text-lg font-black text-gray-800">Ê∑ªÂä†ÂÖªÊä§ÊèêÈÜí</h3>
                                    <button @click="showAddScheduleModal = false" class="text-gray-400">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>

                                <!-- Ê≠•È™§1ÔºöÈÄâÊã©Á±ªÂûã -->
                                <div class="mb-6">
                                    <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">ÈÄâÊã©Á±ªÂûã
                                    </div>
                                    <div class="grid grid-cols-3 gap-2">
                                        <button v-for="type in scheduleTypeOptions" :key="type.value"
                                            @click="newSchedule.careType = type.value; newSchedule.customAction = ''"
                                            class="p-3 rounded-2xl border-2 transition-all text-center" :class="newSchedule.careType === type.value 
                                                ? 'border-purple-400 bg-purple-50' 
                                                : 'border-gray-100 bg-gray-50'">
                                            <div class="text-2xl mb-1">{{ type.icon }}</div>
                                            <div class="text-xs font-bold"
                                                :class="newSchedule.careType === type.value ? 'text-purple-600' : 'text-gray-600'">
                                                {{ type.label }}
                                            </div>
                                        </button>
                                    </div>
                                </div>

                                <!-- ÂÖªÊä§Ë¶ÅÁÇπÂèÇËÄÉ (New) -->
                                <div v-if="currentCareHint"
                                    class="mb-6 bg-blue-50 p-4 rounded-2xl border border-blue-100/50">
                                    <div class="text-xs font-bold text-blue-500 mb-1 flex items-center gap-1">
                                        <i class="fas fa-lightbulb"></i> ÂÖªÊä§Ë¶ÅÁÇπ
                                    </div>
                                    <p class="text-xs text-blue-800/80 leading-relaxed">{{ currentCareHint }}</p>
                                </div>

                                <!-- Ëá™ÂÆö‰πâÂêçÁß∞ËæìÂÖ• (‰ªÖcustomÁ±ªÂûãÊòæÁ§∫) -->
                                <div v-if="newSchedule.careType === 'custom'" class="mb-6">
                                    <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Ëá™ÂÆö‰πâÂêçÁß∞
                                    </div>
                                    <input type="text" v-model="newSchedule.customAction" placeholder="‰æãÂ¶ÇÔºöÊùæÂúü„ÄÅÂñ∑Ê∞¥„ÄÅÊç¢Âúü..."
                                        class="w-full px-4 py-3 rounded-2xl border border-gray-200 text-sm focus:border-purple-400 focus:ring-1 focus:ring-purple-100">
                                </div>

                                <!-- Ê≠•È™§2ÔºöËÆæÁΩÆÂë®Êúü -->
                                <div class="mb-6">
                                    <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">ÊèêÈÜíÂë®Êúü
                                    </div>

                                    <!-- Êô∫ËÉΩÊé®Ëçê (New) -->
                                    <div v-if="smartIntervalSuggestion" class="mb-4">
                                        <button @click="applySmartInterval"
                                            class="w-full py-3 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-2xl shadow-lg shadow-purple-100 flex items-center justify-center gap-2 active:scale-[0.98] transition">
                                            <i class="fas fa-magic"></i>
                                            <span class="text-xs font-bold">ÂºïÁî®ÂéÜÂè≤Âπ≥ÂùáÂë®Êúü ({{ smartIntervalSuggestion
                                                }}Â§©)</span>
                                        </button>
                                        <p class="text-[10px] text-gray-400 text-center mt-2">Âü∫‰∫éÊÇ®ËøáÂéªÁöÑÂÖªÊä§ËÆ∞ÂΩïÂàÜÊûê</p>
                                    </div>

                                    <!-- Âø´Êç∑ÈÄâÊã©Ê†áÁ≠æ -->
                                    <div class="flex gap-2 mb-4">
                                        <button v-for="preset in intervalPresets" :key="preset.days"
                                            @click="newSchedule.intervalDays = preset.days"
                                            class="flex-1 py-2 rounded-xl text-xs font-bold transition-all" :class="newSchedule.intervalDays === preset.days 
                                                ? 'bg-purple-500 text-white' 
                                                : 'bg-gray-100 text-gray-600'">
                                            {{ preset.label }}
                                        </button>
                                    </div>

                                    <!-- Á≤æÁªÜË∞ÉÊï¥ + Áõ¥Êé•ËæìÂÖ• -->
                                    <div class="flex items-center justify-center gap-4 py-4 bg-gray-50 rounded-2xl">
                                        <button
                                            @click="newSchedule.intervalDays = Math.max(1, newSchedule.intervalDays - 1)"
                                            class="w-12 h-12 rounded-2xl bg-white border border-gray-200 text-gray-600 text-lg font-bold active:scale-95 transition shadow-sm">
                                            ‚àí
                                        </button>
                                        <div class="text-center w-20"> <!-- Âõ∫ÂÆöÂÆΩÂ∫¶Èò≤Ê≠¢Ë∑≥Âä® -->
                                            <input type="number" v-model.number="newSchedule.intervalDays"
                                                class="w-full bg-transparent text-center text-3xl font-black text-gray-800 border-none p-0 focus:ring-0 appearance-none"
                                                min="1" max="365">
                                            <div class="text-xs text-gray-400 mt-1">Â§©</div>
                                        </div>
                                        <button @click="newSchedule.intervalDays = newSchedule.intervalDays + 1"
                                            class="w-12 h-12 rounded-2xl bg-white border border-gray-200 text-gray-600 text-lg font-bold active:scale-95 transition shadow-sm">
                                            +
                                        </button>
                                    </div>
                                </div>

                                <!-- ‰øùÂ≠òÊåâÈíÆ -->
                                <button @click="saveNewSchedule" :disabled="!canSaveSchedule"
                                    class="w-full py-4 rounded-2xl font-black text-sm uppercase tracking-wider transition-all"
                                    :class="canSaveSchedule 
                                        ? 'bg-purple-500 text-white active:scale-[0.98]' 
                                        : 'bg-gray-200 text-gray-400 cursor-not-allowed'">
                                    Ê∑ªÂä†ÊèêÈÜí
                                </button>
                            </div>
                        </div>
                    </transition>
                </teleport>

                <!-- 4. ÂÖªÊä§ËÆ∞ÂΩï (Care Records) -->
                <div class="bg-white rounded-3xl shadow-sm border border-gray-50 overflow-hidden">
                    <div class="p-6 flex justify-between items-center border-b border-gray-50">
                        <h3 class="text-lg font-black text-gray-800 flex items-center gap-2">
                            <i class="fas fa-history text-orange-400"></i> ÂÖªÊä§ÂéÜÂè≤
                        </h3>
                        <button @click="goAddCarePage"
                            class="bg-orange-400 text-white px-4 py-1.5 rounded-full text-xs font-black shadow-lg shadow-orange-100 active:scale-95 transition">
                            Êñ∞Â¢ûÂÖªÊä§
                        </button>
                    </div>

                    <!-- ÁªüËÆ°ÊëòË¶ÅÂå∫Âüü -->
                    <div v-if="potStats && careRecords.length > 0"
                        class="px-6 py-4 bg-gray-50/50 border-b border-gray-50">
                        <!-- ÁªüËÆ°Êï∞Â≠ó -->
                        <div class="grid grid-cols-3 gap-3 mb-3">
                            <div class="bg-white rounded-2xl p-3 text-center shadow-sm border border-gray-50">
                                <div class="text-xl font-black text-blue-500">üíß {{ statsWaterCount }}</div>
                                <div class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mt-1">ÊµáÊ∞¥</div>
                            </div>
                            <div class="bg-white rounded-2xl p-3 text-center shadow-sm border border-gray-50">
                                <div class="text-xl font-black text-green-500">üåø {{ statsFertilizeCount }}</div>
                                <div class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mt-1">ÊñΩËÇ•</div>
                            </div>
                            <div class="bg-white rounded-2xl p-3 text-center shadow-sm border border-gray-50">
                                <div class="text-xl font-black text-orange-500">üìÖ {{ statsCareDays }}</div>
                                <div class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mt-1">ÂÖªÊä§Â§©</div>
                            </div>
                        </div>
                        <!-- Âπ≥ÂùáÈó¥Èöî -->
                        <div class="text-center text-[11px] text-gray-400 font-medium">
                            <span v-if="avgWateringInterval !== '-'">Âπ≥ÂùáÊµáÊ∞¥Èó¥Èöî <span class="text-blue-500 font-bold">{{
                                    avgWateringInterval }}</span> Â§©</span>
                            <span v-if="avgWateringInterval !== '-' && avgFertilizingInterval !== '-'"
                                class="mx-2">¬∑</span>
                            <span v-if="avgFertilizingInterval !== '-'">Âπ≥ÂùáÊñΩËÇ•Èó¥Èöî <span class="text-green-500 font-bold">{{
                                    avgFertilizingInterval }}</span> Â§©</span>
                        </div>
                    </div>

                    <div v-if="careRecords.length === 0" class="p-10 text-center">
                        <p class="text-gray-400 text-sm">ÊöÇÊó†ÂÖªÊä§ËÆ∞ÂΩï</p>
                    </div>

                    <div v-else class="divide-y divide-gray-50">
                        <div v-for="group in groupedCareRecords.slice(0, 5)" :key="group.date"
                            @click="showCareDetails(group)"
                            class="group py-4 px-6 active:bg-gray-50 transition cursor-pointer flex items-center justify-between">
                            <div class="flex items-baseline gap-4 min-w-0">
                                <!-- Êó•ÊúüÂú®Ââç -->
                                <span class="text-xs font-black text-gray-800 uppercase shrink-0 w-24 leading-none">
                                    {{ group.date }}
                                </span>

                                <!-- Ê¶ÇÊã¨Âú®Âêé -->
                                <div class="min-w-0">
                                    <div class="text-xs font-bold text-gray-400 truncate">
                                        {{ group.displayAction }}
                                    </div>
                                    <p v-if="group.displayDescription" class="text-[10px] text-gray-300 mt-1 truncate">
                                        {{ group.displayDescription }}
                                    </p>
                                </div>
                            </div>
                            <i
                                class="fas fa-chevron-right text-[10px] text-gray-200 group-active:text-gray-400 transition"></i>
                        </div>

                        <button v-if="careRecords.length > 0" @click="viewAllRecords"
                            class="w-full py-4 text-[10px] text-gray-300 font-black uppercase tracking-widest bg-gray-50/50 border-t border-gray-50 flex items-center justify-center gap-2">
                            Êü•ÁúãÂÆåÊï¥ÂéÜÂè≤Ê°£Ê°à ({{ careRecords.length }}) <i class="fas fa-history"></i>
                        </button>
                    </div>
                </div>

                <!-- 3. ÁîüÈïøËÆ∞ÂΩïÂÖ•Âè£ (Entry Logic) -->
                <div class="bg-white rounded-3xl shadow-sm border border-gray-50 overflow-hidden">
                    <div class="p-6 flex justify-between items-center border-b border-gray-50">
                        <h3 class="text-lg font-black text-gray-800 flex items-center gap-2">
                            <i class="fas fa-chart-line text-blue-500"></i> ÁîüÈïøËΩ®Ëøπ
                        </h3>
                        <div class="flex gap-2">
                            <button v-if="timelineRecords.length >= 2" @click="toggleTimelineSort"
                                class="w-8 h-8 rounded-full bg-gray-100/80 text-gray-500 flex items-center justify-center active:scale-90 transition">
                                <i class="fas text-[12px]"
                                    :class="isTimelineDesc ? 'fa-sort-amount-down' : 'fa-sort-amount-up'"></i>
                            </button>
                            <button @click="showAddTimelineModal = true"
                                class="bg-blue-500 text-white px-4 py-1.5 rounded-full text-xs font-black shadow-lg shadow-blue-100 active:scale-95 transition">
                                ËÆ∞ÂΩïËøô‰∏ÄÂàª
                            </button>
                        </div>
                    </div>

                    <!-- Êó∂Èó¥ËΩ¥ÂÜÖÂÆπ -->
                    <div v-if="timelineRecords.length === 0" class="p-10 text-center">
                        <div
                            class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-300">
                            <i class="fas fa-camera text-2xl"></i>
                        </div>
                        <p class="text-gray-400 text-sm">ËøòÊ≤°ÊúâÁïô‰∏ãÂÆÉÁöÑÊàêÈïøÁû¨Èó¥</p>
                        <p class="text-[10px] text-gray-300 mt-1">‰∏ä‰º†ÁÖßÁâáÔºåËÆ∞ÂΩïÂÆÉÁöÑÊØè‰∏Ä‰∏™ÂèòÂåñ</p>
                    </div>

                    <div v-else class="p-6 space-y-6">
                        <div v-for="record in sortedTimelineRecords" :key="record.id"
                            class="relative pl-6 border-l-2 border-blue-50">
                            <!-- Êó∂Èó¥ÁÇπ -->
                            <div
                                class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-white border-4 border-blue-500 shadow-sm">
                            </div>

                            <div class="flex justify-between items-start mb-2">
                                <span class="text-xs font-black text-gray-400">{{ formatDate(record.date) }}</span>
                                <button @click="confirmDeleteTimeline(record.id)"
                                    class="text-gray-300 hover:text-red-400 p-1 active:scale-90 transition">
                                    <i class="fas fa-trash-alt text-xs"></i>
                                </button>
                            </div>
                            <p class="text-sm text-gray-700 mb-3 font-medium">{{ record.description || 'Ëøô‰∏ÄÂ§©ÔºåÊúâ‰∫ÜÊñ∞ÁöÑÊàêÈïø...'
                                }}</p>

                            <!-- ÂõæÁâáÂ±ïÁ§∫ÁΩëÊ†º -->
                            <div v-if="getImages(record.images).length > 0" class="grid grid-cols-3 gap-2">
                                <div v-for="(img, idx) in getImages(record.images)" :key="idx"
                                    class="aspect-square rounded-2xl overflow-hidden bg-gray-100 shadow-sm">
                                    <img :src="img"
                                        class="w-full h-full object-cover cursor-pointer active:opacity-75 transition"
                                        @click="openGallery(img, getImages(record.images))">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. Âà†Èô§ÊåâÈíÆ (ÁßªËá≥ÊúÄÂ∫ïÈÉ®) -->
                <div class="pt-8 pb-10 flex flex-col items-center gap-4">
                    <button @click="confirmDeletePot"
                        class="w-full py-4 rounded-2xl text-red-500 font-black text-sm bg-red-50 border border-red-100 hover:bg-red-100 transition active:scale-95">
                        <i class="fas fa-trash-alt mr-2"></i> Âà†Èô§Ê≠§Ëä±ÁõÜ
                    </button>
                    <p class="text-[10px] text-gray-300 text-center uppercase tracking-widest font-black">
                        ID: {{ potId }} ‚Ä¢ Êõ¥Êñ∞‰∫é {{ formatDate(new Date().toISOString()) }}
                    </p>
                </div>
            </div>

            <!-- ÂºπÁ™óÔºöÊ∑ªÂä†ÁîüÈïøËÆ∞ÂΩï -->
            <div v-if="showAddTimelineModal"
                class="fixed inset-0 z-[60] flex items-end sm:items-center justify-center p-4">
                <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="showAddTimelineModal = false"></div>
                <div
                    class="relative bg-white w-full max-w-lg rounded-t-3xl sm:rounded-3xl overflow-hidden shadow-2xl animate-slide-up">
                    <div class="p-8">
                        <div class="flex justify-between items-center mb-8">
                            <div>
                                <h3 class="text-xl font-black text-gray-800">Â¢ûÂä†ÁîüÈïøËÆ∞ÂΩï</h3>
                                <p class="text-xs text-gray-400 mt-1">ËÆ∞ÂΩïÂπ∂ËßÅËØÅÂÆÉÁöÑÊàêÈïøËúïÂèò</p>
                            </div>
                            <button @click="showAddTimelineModal = false"
                                class="text-gray-300 hover:text-gray-500 transition">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div class="space-y-6">
                            <div>
                                <label
                                    class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-2 ml-1">ËÆ∞ÂΩïÊó•Êúü</label>
                                <input type="date" v-model="newTimeline.date"
                                    class="w-full bg-gray-50 border-none rounded-2xl py-4 px-6 focus:ring-2 focus:ring-blue-500 transition-all font-bold text-gray-800">
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-2 ml-1">ÊñáÂ≠óËØ¥Êòé</label>
                                <textarea v-model="newTimeline.description" rows="3" placeholder="ÂÜôÁÇπ‰ªÄ‰πàÔºåËÆ∞ÂΩïËøô‰∏ÄÂàªÁöÑÂñúÊÇ¶..."
                                    class="w-full bg-gray-50 border-none rounded-2xl py-4 px-6 focus:ring-2 focus:ring-blue-500 transition-all font-bold text-gray-800 resize-none"></textarea>
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-2 ml-1">‰∏ä‰º†ÁÖßÁâá
                                    (Â§öÈÄâ, ÊúÄÂ§ö9Âº†)</label>
                                <div class="grid grid-cols-4 gap-2 mt-2">
                                    <div v-for="(img, idx) in newTimeline.tempImages" :key="idx"
                                        class="relative aspect-square bg-gray-100 rounded-xl overflow-hidden">
                                        <img :src="img.preview" class="w-full h-full object-cover">
                                        <button @click="removeNewImage(idx)"
                                            class="absolute top-1 right-1 bg-black/50 text-white w-5 h-5 rounded-full text-[10px] flex items-center justify-center">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <button v-if="newTimeline.tempImages.length < 9" @click="triggerFileInput"
                                        class="aspect-square border-2 border-dashed border-gray-200 rounded-xl flex flex-col items-center justify-center text-gray-300 hover:border-blue-500 hover:text-blue-500 transition active:scale-95">
                                        <i class="fas fa-camera text-xl mb-1"></i>
                                        <span class="text-[8px] font-black uppercase tracking-tighter">Ê∑ªÂä†</span>
                                    </button>
                                </div>
                                <input type="file" ref="fileInput" @change="onFilesSelected" multiple accept="image/*"
                                    class="hidden">
                            </div>
                        </div>

                        <div class="mt-10">
                            <button @click="saveTimelineRecord" :disabled="isSavingTimeline"
                                class="w-full bg-blue-500 text-white py-4 rounded-2xl text-lg font-black shadow-xl shadow-blue-100 disabled:opacity-50 transition active:scale-[0.98]">
                                <span v-if="!isSavingTimeline">ÂèëÂ∏ÉËÆ∞ÂΩï</span>
                                <span v-else><i class="fas fa-spinner fa-spin mr-2"></i>Ê≠£Âú®ÂêåÊ≠•...</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÂºπÁ™óÔºöÊ§çÁâ©ÁôæÁßëËØ¶ÁªÜ -->
            <div v-if="showPlantModal" class="fixed inset-0 z-[60] flex items-center justify-center p-4">
                <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" @click="showPlantModal = false"></div>
                <div
                    class="relative bg-white w-full max-w-xl max-h-[90vh] rounded-[2.5rem] overflow-hidden shadow-2xl flex flex-col">
                    <div class="p-8 border-b border-gray-50 flex justify-between items-center bg-green-50/50">
                        <div>
                            <h3 class="text-xl font-black text-green-800">{{ plantInfo?.basicInfo?.name }}</h3>
                            <p class="text-[10px] font-black text-green-600 uppercase tracking-widest mt-1">{{
                                plantInfo.basicInfo?.latinName }}</p>
                        </div>
                        <button @click="showPlantModal = false"
                            class="text-green-800 opacity-40 hover:opacity-100 transition">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="p-8 overflow-y-auto flex-1 space-y-8">
                        <section>
                            <h4
                                class="text-xs font-black text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                                <i class="fas fa-info-circle text-green-500"></i> Âü∫Êú¨ËµÑÊñô
                            </h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div class="bg-gray-50 p-4 rounded-2xl col-span-2"
                                    v-if="plantInfo.basicInfo?.synonyms?.length">
                                    <span class="text-[10px] text-gray-400 font-bold block mb-1 uppercase">Âà´Âêç</span>
                                    <span class="font-bold">{{ plantInfo.basicInfo.synonyms.join('„ÄÅ') }}</span>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-2xl"><span
                                        class="text-[10px] text-gray-400 font-bold block mb-1 uppercase">ÁßëÂ±û</span><span
                                        class="font-bold">{{ plantInfo.basicInfo?.family }}</span></div>
                                <div class="bg-gray-50 p-4 rounded-2xl"><span
                                        class="text-[10px] text-gray-400 font-bold block mb-1 uppercase">Âéü‰∫ßÂú∞</span><span
                                        class="font-bold">{{ plantInfo.basicInfo?.origin }}</span></div>
                            </div>
                        </section>

                        <section v-if="plantInfo.ornamentalFeatures">
                            <h4
                                class="text-xs font-black text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                                <i class="fas fa-eye text-green-500"></i> ËßÇËµèÁâπÂæÅ
                            </h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div v-for="(val, key) in plantInfo.ornamentalFeatures" :key="key" v-show="val"
                                    class="bg-gray-50 p-4 rounded-2xl">
                                    <span class="text-[10px] text-gray-400 font-bold block mb-1 uppercase">{{
                                        getOrnamentalLabel(key) }}</span>
                                    <span class="font-bold">{{ val === true ? 'ÊòØ' : (val === false ? 'Âê¶' : val)
                                        }}</span>
                                </div>
                            </div>
                        </section>

                        <section>
                            <h4
                                class="text-xs font-black text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                                <i class="fas fa-hand-holding-heart text-green-500"></i> ÂÖ®Êñπ‰ΩçÂÖªÊä§ÊåáÂçó
                            </h4>
                            <div class="grid grid-cols-1 gap-4">
                                <div v-for="(val, key) in plantInfo.careGuide" v-show="val"
                                    class="flex gap-4 p-4 bg-gray-50 rounded-2xl">
                                    <div
                                        class="w-10 h-10 rounded-xl bg-white flex items-center justify-center shrink-0 shadow-sm">
                                        <i :class="getCareIcon(key)" class="text-green-500"></i>
                                    </div>
                                    <div>
                                        <span
                                            class="text-[10px] text-gray-400 font-black uppercase tracking-widest block mb-0.5">{{
                                            getCareLabel(key) }}</span>
                                        <span class="text-gray-700 text-sm font-medium leading-relaxed">{{ val }}</span>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>

            <!-- ÂõæÁâáÂÖ®Â±èÈ¢ÑËßà -->
            <!-- ÂõæÁâáÂÖ®Â±èÁîªÂªä -->
            <div v-if="previewImages.length > 0"
                class="fixed inset-0 z-[100] bg-black flex items-center justify-center animate-fade-in touch-none"
                @click.self="closeGallery" @touchstart="handleGalleryTouchStart" @touchmove="handleGalleryTouchMove"
                @touchend="handleGalleryTouchEnd">
                <button @click="closeGallery"
                    class="absolute top-6 right-6 text-white/50 hover:text-white p-4 z-[110] transition">
                    <i class="fas fa-times text-2xl shadow-sm"></i>
                </button>

                <!-- Â∑¶Âè≥ÂàáÊç¢ÊåâÈíÆ -->
                <button v-if="previewImages.length > 1" @click.stop="prevImg"
                    class="absolute left-2 top-1/2 -translate-y-1/2 p-4 text-white/50 hover:text-white z-[110] transition disabled:opacity-20"
                    :disabled="previewIndex === 0">
                    <i class="fas fa-chevron-left text-3xl drop-shadow-md"></i>
                </button>
                <button v-if="previewImages.length > 1" @click.stop="nextImg"
                    class="absolute right-2 top-1/2 -translate-y-1/2 p-4 text-white/50 hover:text-white z-[110] transition disabled:opacity-20"
                    :disabled="previewIndex === previewImages.length - 1">
                    <i class="fas fa-chevron-right text-3xl drop-shadow-md"></i>
                </button>

                <img :src="previewImages[previewIndex]"
                    class="max-w-full max-h-full object-contain transition-transform duration-300"
                    @click="closeGallery">

                <div
                    class="absolute bottom-10 left-0 right-0 text-center text-white/80 text-sm font-bold tracking-widest pointer-events-none">
                    {{ previewIndex + 1 }} / {{ previewImages.length }}
                </div>
            </div>

            <!-- ÂÖªÊä§ËØ¶ÊÉÖ Bottom Sheet -->
            <teleport to="body">
                <transition name="backdrop">
                    <div v-if="activeCareDate" @click="closeCareDetails"
                        class="fixed inset-0 bg-black/60 backdrop-blur-[2px] z-[100]"></div>
                </transition>

                <transition name="bottom-sheet">
                    <div v-if="activeCareDate && currentSheetGroup"
                        class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl rounded-t-[3rem] p-8 pb-12 shadow-2xl z-[101] max-h-[85vh] overflow-hidden flex flex-col border-t border-white/20">
                        <!-- È°∂ÈÉ®ÊääÊâã -->
                        <div class="w-16 h-1.5 bg-gray-200/50 rounded-full mx-auto mb-10 shrink-0"></div>

                        <div class="flex justify-between items-start mb-10 shrink-0">
                            <div>
                                <h2 class="text-2xl font-black text-gray-800">{{ activeCareDate }}</h2>
                            </div>
                            <button @click="closeCareDetails"
                                class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 active:scale-95 transition">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div class="space-y-4 overflow-y-auto pr-2 flex-1 no-scrollbar">
                            <div v-for="record in currentSheetGroup.records" :key="record.id"
                                class="flex items-center justify-between p-5 bg-white rounded-3xl border border-gray-50 shadow-sm">
                                <div class="flex items-center gap-5">
                                    <div :class="getCareTypeColor(record.type)"
                                        class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl shadow-inner">
                                        <i :class="getCareTypeIcon(record.type)"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-black text-gray-700">
                                            {{ record.action || getCareTypeLabel(record.type) }}
                                        </p>
                                        <p v-if="record.description && record.description !== record.action"
                                            class="text-[10px] text-gray-400 mt-0.5">
                                            {{ record.description }}
                                        </p>
                                    </div>
                                </div>
                                <div class="flex gap-3">
                                    <button @click="editRecord(record)"
                                        class="w-11 h-11 flex items-center justify-center rounded-2xl bg-orange-50 text-orange-400 active:scale-90 transition">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button @click="deleteRecord(record)"
                                        class="w-11 h-11 flex items-center justify-center rounded-2xl bg-red-50 text-red-400 active:scale-90 transition">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mt-10 shrink-0">
                            <button @click="closeCareDetails"
                                class="w-full py-5 bg-gray-900 text-white rounded-3xl font-black text-xs uppercase tracking-[0.2em] active:scale-[0.98] transition">
                                Â•ΩÁöÑ
                            </button>
                        </div>
                    </div>
                </transition>
            </teleport>
        </main>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, computed } = Vue;

        createApp({
            setup() {
                // --- Áä∂ÊÄÅÂèòÈáè ---
                const isLoading = ref(true);
                const error = ref(null);
                const potId = ref(null);
                const pot = ref(null);
                const careRecords = ref([]);
                const timelineRecords = ref([]);
                const plantInfo = ref(null);
                const matchedPlantName = ref(null);
                const activeCareDate = ref(null);
                const showFullPlantInfo = ref(false); // ÊéßÂà∂ÁôæÁßëÂü∫Êú¨‰ø°ÊÅØÂ±ïÂºÄ
                const showFullCareTips = ref(false);  // ÊéßÂà∂ÂÖªÊä§ÊèêÁ§∫Â±ïÂºÄ
                const potStats = ref(null); // ÂÖªÊä§ÁªüËÆ°Êï∞ÊçÆ

                // UI Áä∂ÊÄÅ
                const showPlantModal = ref(false);
                const showAddTimelineModal = ref(false);
                const isTimelineDesc = ref(true); // ÈªòËÆ§ÂÄíÂ∫è
                const previewImages = ref([]);
                const previewIndex = ref(0);
                const isSavingTimeline = ref(false);
                const fileInput = ref(null);

                // Ëß¶Êë∏Áõ∏ÂÖ≥Áä∂ÊÄÅ
                const touchStartX = ref(0);
                const touchEndX = ref(0);

                // Êñ∞ËÆ∞ÂΩïË°®Âçï
                const newTimeline = reactive({
                    date: new Date().toISOString().split('T')[0],
                    description: '',
                    tempImages: [] // { file, preview }
                });

                // ÂÖªÊä§Âë®ÊúüÁä∂ÊÄÅ (Êñ∞ÁâàÔºöÁªü‰∏ÄÁÆ°ÁêÜ)
                const careSchedules = ref([]); // Â∑≤ËÆæÁΩÆÁöÑÂÖªÊä§ËÆ°ÂàíÂàóË°®
                const showScheduleExpanded = ref(false); // ÈªòËÆ§ÊäòÂè†
                const showAddScheduleModal = ref(false);
                const newSchedule = reactive({
                    careType: 'water',
                    customAction: '',
                    intervalDays: 7
                });

                // ÂÖªÊä§Á±ªÂûãÈÄâÈ°π
                const scheduleTypeOptions = [
                    { value: 'water', icon: 'üíß', label: 'ÊµáÊ∞¥' },
                    { value: 'fertilize', icon: 'üåø', label: 'ÊñΩËÇ•' },
                    { value: 'trim', icon: '‚úÇÔ∏è', label: '‰øÆÂâ™' },
                    { value: 'repot', icon: 'ü™¥', label: 'Êç¢ÁõÜ' },
                    { value: 'pest', icon: 'üêõ', label: 'Èô§Ëô´' },
                    { value: 'custom', icon: '‚öôÔ∏è', label: 'Ëá™ÂÆö‰πâ' }
                ];

                // Âë®ÊúüÂø´Êç∑ÈÄâÈ°π
                const intervalPresets = [
                    { days: 3, label: '3Â§©' },
                    { days: 7, label: 'ÊØèÂë®' },
                    { days: 14, label: '2Âë®' },
                    { days: 30, label: 'ÊØèÊúà' }
                ];

                // ËÆ°ÁÆóÂ±ûÊÄßÔºöËÉΩÂê¶‰øùÂ≠ò
                const canSaveSchedule = computed(() => {
                    if (!newSchedule.careType) return false;
                    if (newSchedule.careType === 'custom' && !newSchedule.customAction.trim()) return false;
                    if (newSchedule.intervalDays < 1 || newSchedule.intervalDays > 90) return false;
                    return true;
                });

                // Ëé∑ÂèñÁ±ªÂûãÊ†∑Âºè
                const getScheduleTypeStyle = (type) => {
                    const styles = {
                        water: { bg: 'bg-blue-50', icon: 'üíß', toggle: 'bg-blue-500' },
                        fertilize: { bg: 'bg-green-50', icon: 'üåø', toggle: 'bg-green-500' },
                        trim: { bg: 'bg-orange-50', icon: '‚úÇÔ∏è', toggle: 'bg-orange-500' },
                        repot: { bg: 'bg-amber-50', icon: 'ü™¥', toggle: 'bg-amber-500' },
                        pest: { bg: 'bg-red-50', icon: 'üêõ', toggle: 'bg-red-500' },
                        custom: { bg: 'bg-purple-50', icon: '‚öôÔ∏è', toggle: 'bg-purple-500' }
                    };
                    return styles[type] || styles.custom;
                };

                // Ëé∑ÂèñÁ±ªÂûãÂêçÁß∞
                const getScheduleTypeName = (type) => {
                    const names = { water: 'ÊµáÊ∞¥', fertilize: 'ÊñΩËÇ•', trim: '‰øÆÂâ™', repot: 'Êç¢ÁõÜ', pest: 'Èô§Ëô´', custom: 'Ëá™ÂÆö‰πâ' };
                    return names[type] || type;
                };

                // --- ÂàùÂßãÂåñÂä†ËΩΩ ---
                const init = async () => {
                    const urlParams = new URLSearchParams(window.location.search);
                    potId.value = urlParams.get('id');

                    if (!potId.value) {
                        error.value = 'Êú™ÊâæÂà∞Ëä±ÁõÜID';
                        isLoading.value = false;
                        return;
                    }

                    try {
                        await Promise.all([
                            loadPotDetail(),
                            loadCareRecords(),
                            loadTimelineRecords(),
                            loadPotStats(),
                            loadCareSchedules()
                        ]);
                        if (pot.value) await loadPlantInfo();
                    } catch (err) {
                        console.error('Âä†ËΩΩÂ§±Ë¥•:', err);
                        error.value = 'Êï∞ÊçÆÂêåÊ≠•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªú';
                    } finally {
                        isLoading.value = false;
                    }
                };

                // Âä†ËΩΩÂÖªÊä§Âë®ÊúüËÆæÁΩÆ
                const loadCareSchedules = async () => {
                    try {
                        const res = await apiClient.getCareSchedules(potId.value);
                        if (res.success && res.data) {
                            careSchedules.value = res.data.map(s => ({
                                ...s,
                                intervalDays: s.interval_days, // Êò†Â∞ÑÂ≠óÊÆµÂêç
                                enabled: s.enabled === 1
                            }));
                        }
                    } catch (e) {
                        console.warn('Âä†ËΩΩÂÖªÊä§Âë®ÊúüÂ§±Ë¥•:', e);
                    }
                };

                // ‰øùÂ≠òÊñ∞ÊèêÈÜí
                const saveNewSchedule = async () => {
                    if (!canSaveSchedule.value) return;

                    try {
                        const res = await apiClient.createCareSchedule({
                            potId: potId.value,
                            careType: newSchedule.careType,
                            customAction: newSchedule.careType === 'custom' ? newSchedule.customAction : null,
                            intervalDays: newSchedule.intervalDays,
                            enabled: true
                        });

                        if (res.success) {
                            showAddScheduleModal.value = false;
                            // ÈáçÁΩÆË°®Âçï
                            newSchedule.careType = 'water';
                            newSchedule.customAction = '';
                            newSchedule.intervalDays = 7;
                            // ÈáçÊñ∞Âä†ËΩΩÂàóË°®
                            await loadCareSchedules();
                        }
                    } catch (e) {
                        console.error('ÂàõÂª∫Â§±Ë¥•:', e);
                        if (e.message && e.message.includes('already exists')) {
                            alert('ËØ•Á±ªÂûãÁöÑÊèêÈÜíÂ∑≤Â≠òÂú®ÔºåËØ∑Áõ¥Êé•‰øÆÊîπÁé∞ÊúâÊèêÈÜí„ÄÇ');
                        } else {
                            alert('ÂàõÂª∫Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
                        }
                    }
                };

                // ÂàáÊç¢ÂêØÁî®Áä∂ÊÄÅ
                const toggleScheduleEnabled = async (schedule) => {
                    const originalState = schedule.enabled;
                    schedule.enabled = !originalState; // ‰πêËßÇÊõ¥Êñ∞

                    try {
                        await apiClient.updateCareSchedule(schedule.id, {
                            enabled: schedule.enabled
                        });
                    } catch (e) {
                        console.error('ÂàáÊç¢Áä∂ÊÄÅÂ§±Ë¥•:', e);
                        schedule.enabled = originalState; // ÂõûÊªö
                    }
                };

                // Âà†Èô§ÊèêÈÜí
                const deleteSchedule = async (schedule) => {
                    if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÊèêÈÜíÂêóÔºü')) return;

                    try {
                        const res = await apiClient.deleteCareSchedule(schedule.id);
                        if (res.success) {
                            careSchedules.value = careSchedules.value.filter(s => s.id !== schedule.id);
                        }
                    } catch (e) {
                        console.error('Âà†Èô§Â§±Ë¥•:', e);
                        alert('Âà†Èô§Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
                    }
                };

                // Êõ¥Êñ∞ÊèêÈÜíÈó¥Èöî
                const updateScheduleInterval = async (schedule) => {
                    if (schedule.intervalDays < 1) schedule.intervalDays = 1;
                    if (schedule.intervalDays > 365) schedule.intervalDays = 365;

                    try {
                        await apiClient.updateCareSchedule(schedule.id, {
                            intervalDays: schedule.intervalDays
                        });
                    } catch (e) {
                        console.error('Êõ¥Êñ∞Èó¥ÈöîÂ§±Ë¥•:', e);
                        alert('Êõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªú');
                    }
                };

                const loadPotDetail = async () => {
                    const res = await apiClient.getPotDetail(potId.value);
                    if (res.success) pot.value = res.data;
                };

                const loadCareRecords = async () => {
                    const res = await apiClient.getCareRecords(potId.value);
                    if (res.success) careRecords.value = res.data || [];
                };

                const loadTimelineRecords = async () => {
                    const res = await apiClient.getTimelines(potId.value);
                    if (res.success) timelineRecords.value = res.data || [];
                };

                const loadPotStats = async () => {
                    try {
                        const res = await apiClient.getPotStats(potId.value);
                        if (res.success) potStats.value = res.data;
                    } catch (e) {
                        console.warn('Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•:', e);
                    }
                };

                // ÁªüËÆ°ËÆ°ÁÆóÂ±ûÊÄß
                const statsWaterCount = computed(() => {
                    const item = potStats.value?.byType?.find(t => t.type === 'water' || t.type === 'ÊµáÊ∞¥');
                    return item?.total_count || 0;
                });

                const statsFertilizeCount = computed(() => {
                    const item = potStats.value?.byType?.find(t => t.type === 'fertilize' || t.type === 'ÊñΩËÇ•');
                    return item?.total_count || 0;
                });

                const statsCareDays = computed(() => potStats.value?.total?.care_days || 0);

                const avgWateringInterval = computed(() => {
                    const recent = potStats.value?.recent?.find(t => t.type === 'water' || t.type === 'ÊµáÊ∞¥');
                    if (recent && recent.count > 0) return (30 / recent.count).toFixed(1);
                    return '-';
                });

                const avgFertilizingInterval = computed(() => {
                    const recent = potStats.value?.recent?.find(t => t.type === 'fertilize' || t.type === 'ÊñΩËÇ•');
                    if (recent && recent.count > 0) return (30 / recent.count).toFixed(1);
                    return '-';
                });

                const loadPlantInfo = async () => {
                    if (!pot.value?.name) return;
                    try {
                        // ‰ΩøÁî®Êô∫ËÉΩÂåπÈÖçAPIÔºåÂêåÊó∂‰º†ÈÄíËä±ÁõÜÂêçÂíåÂ§áÊ≥®
                        const matchRes = await apiClient.smartMatchPlant(
                            pot.value.name,
                            pot.value.note || ''
                        );

                        if (matchRes.success && matchRes.data) {
                            plantInfo.value = transformPlantData(matchRes.data);
                            // Â¶ÇÊûúÂåπÈÖçÂà∞ÁöÑÊ§çÁâ©Âêç‰∏éËä±ÁõÜÂêç‰∏çÂêåÔºåÊòæÁ§∫ÂåπÈÖçÊèêÁ§∫
                            if (matchRes.data.name !== pot.value.name) {
                                matchedPlantName.value = matchRes.data.name;
                            }
                            console.log('Êô∫ËÉΩÂåπÈÖçÊàêÂäü:', matchRes.message, 'ÂÖ≥ÈîÆËØç:', matchRes.keywords);
                        }
                    } catch (e) { console.warn('ÁôæÁßëÂåπÈÖçÂ§±Ë¥•', e); }
                };

                const sortedTimelineRecords = computed(() => {
                    return [...timelineRecords.value].sort((a, b) => {
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        return isTimelineDesc.value ? dateB - dateA : dateA - dateB;
                    });
                });

                const toggleTimelineSort = () => isTimelineDesc.value = !isTimelineDesc.value;

                // --- ‰∫§‰∫íÈÄªËæë ---
                const goBack = () => {
                    // ËØ¶ÊÉÖÈ°µÂº∫Âà∂ÂõûÈ¶ñÈ°µ
                    window.location.href = 'index.html';
                };
                const goEditPage = () => window.location.href = `edit-pot.html?id=${potId.value}`;
                const goAddCarePage = () => window.location.href = `care-record.html?potId=${potId.value}`;

                const confirmDeletePot = async () => {
                    if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÁõÜËä±ÂêóÔºüÊâÄÊúâÂÖªÊä§ËÆ∞ÂΩïÂíåÊàêÈïøËΩ®ËøπÈÉΩÂ∞ÜË¢´Ê∞∏‰πÖÂà†Èô§„ÄÇ')) {
                        try {
                            const res = await apiClient.deletePot(potId.value);
                            if (res.success) {
                                window.location.href = 'index.html';
                            }
                        } catch (err) {
                            alert('Âà†Èô§Â§±Ë¥•: ' + err.message);
                        }
                    }
                };

                // ÊäΩÂ±âÁÆ°ÁêÜ
                const showCareDetails = (group) => {
                    activeCareDate.value = group.date;
                };
                const closeCareDetails = () => {
                    activeCareDate.value = null;
                };
                const currentSheetGroup = computed(() => {
                    if (!activeCareDate.value) return null;
                    const group = groupedCareRecords.value.find(g => g.date === activeCareDate.value);
                    if (!group) activeCareDate.value = null; // Â¶ÇÊûúËÆ∞ÂΩïÂÖ®Ë¢´Âà†‰∫ÜÔºåËá™Âä®ÂÖ≥Èó≠
                    return group;
                });

                // --- ÁôæÁßë‰ø°ÊÅØÊòæÁ§∫ËøáÊª§ÈÄªËæë ---
                const plantBasicPriorityKeys = ['synonyms', 'flowerColor', 'floweringSeason', 'fragrance', 'symbolism', 'safetyInfo'];
                const careGuidePriorityKeys = ['careDifficulty', 'lightRequirement', 'watering', 'temperature', 'fertilizing', 'pests'];

                // ÊãÜÂàÜÂü∫Êú¨‰ø°ÊÅØ
                const plantInfoGroups = computed(() => {
                    if (!plantInfo.value) return { priority: [], extended: [] };

                    const allFields = [
                        { key: 'synonyms', label: 'Âà´„ÄÄÂêç', val: plantInfo.value.basicInfo?.synonyms?.join('„ÄÅ'), section: 'basicInfo' },
                        { key: 'origin', label: 'Âéü‰∫ßÂú∞', val: plantInfo.value.basicInfo?.origin, section: 'basicInfo' },
                        { key: 'family', label: 'Áßë„ÄÄÂ±û', val: plantInfo.value.basicInfo?.family, section: 'basicInfo' },
                        { key: 'category', label: 'Á±ª„ÄÄÂà´', val: plantInfo.value.ornamentalFeatures?.category, section: 'ornamentalFeatures' },
                        { key: 'flowerColor', label: 'Ëä±„ÄÄËâ≤', val: plantInfo.value.ornamentalFeatures?.flowerColor, section: 'ornamentalFeatures' },
                        { key: 'floweringSeason', label: 'Ëä±„ÄÄÊúü', val: plantInfo.value.ornamentalFeatures?.floweringSeason, section: 'ornamentalFeatures' },
                        { key: 'fragrance', label: 'È¶ô„ÄÄÂë≥', val: plantInfo.value.ornamentalFeatures?.fragrance, section: 'ornamentalFeatures' },
                        { key: 'symbolism', label: 'Ë±°„ÄÄÂæÅ', val: plantInfo.value.ornamentalFeatures?.symbolism, section: 'ornamentalFeatures' },
                        { key: 'safetyInfo', label: 'ÂÆâÂÖ®ÊÄß', val: plantInfo.value.careGuide?.safetyInfo, section: 'careGuide' }
                    ].filter(item => item.val);

                    return {
                        priority: allFields.filter(f => plantBasicPriorityKeys.includes(f.key)),
                        extended: allFields.filter(f => !plantBasicPriorityKeys.includes(f.key))
                    };
                });

                // ÊãÜÂàÜÂÖªÊä§ÊèêÁ§∫ (ÊñπÊ°àBÔºöÈ°∂ÈÉ®ÊÄªÁªì + ‰∏ãÊñπÊó•ÂøóÂùó)
                const careTipsGroups = computed(() => {
                    if (!plantInfo.value || !plantInfo.value.careGuide) return { summary: [], priorityDetails: [], extended: [] };

                    const careGuide = plantInfo.value.careGuide;
                    const summaryKeys = ['careDifficulty', 'temperature'];
                    const detailPriorityKeys = ['lightRequirement', 'watering', 'fertilizing', 'pests'];

                    const allFields = Object.keys(careGuide)
                        .filter(k => careGuide[k])
                        .map(key => ({
                            key,
                            label: getCareLabel(key),
                            val: careGuide[key],
                            icon: getCareIcon(key)
                        }));

                    return {
                        summary: allFields.filter(f => summaryKeys.includes(f.key)),
                        priorityDetails: allFields.filter(f => detailPriorityKeys.includes(f.key)),
                        extended: allFields.filter(f => !summaryKeys.includes(f.key) && !detailPriorityKeys.includes(f.key))
                    };
                });

                const openGallery = (img, allImages) => {
                    previewImages.value = allImages;
                    const idx = allImages.indexOf(img);
                    previewIndex.value = idx >= 0 ? idx : 0;
                };

                const closeGallery = () => {
                    previewImages.value = [];
                    previewIndex.value = 0;
                };

                const prevImg = () => {
                    if (previewIndex.value > 0) previewIndex.value--;
                };

                const nextImg = () => {
                    if (previewIndex.value < previewImages.value.length - 1) previewIndex.value++;
                };

                // ÁîªÂªäËß¶Êë∏ÊªëÂä®ÈÄªËæë
                const handleGalleryTouchStart = (e) => {
                    touchStartX.value = e.changedTouches[0].screenX;
                    touchEndX.value = e.changedTouches[0].screenX; // ÂàùÂßãÂåñÈò≤Ê≠¢misclick
                };

                const handleGalleryTouchMove = (e) => {
                    touchEndX.value = e.changedTouches[0].screenX;
                };

                const handleGalleryTouchEnd = () => {
                    const threshold = 50; // ÊªëÂä®ÈòàÂÄº
                    const diff = touchStartX.value - touchEndX.value;

                    if (Math.abs(diff) > threshold) {
                        if (diff > 0) {
                            // ÂêëÂ∑¶Êªë -> ‰∏ã‰∏ÄÂº†
                            nextImg();
                        } else {
                            // ÂêëÂè≥Êªë -> ‰∏ä‰∏ÄÂº†
                            prevImg();
                        }
                    }
                    // ÈáçÁΩÆ
                    touchStartX.value = 0;
                    touchEndX.value = 0;
                };

                // --- ÁîüÈïøËÆ∞ÂΩïÂäüËÉΩ ---
                const triggerFileInput = () => fileInput.value.click();

                const onFilesSelected = (e) => {
                    const files = Array.from(e.target.files);
                    const remaining = 9 - newTimeline.tempImages.length;

                    files.slice(0, remaining).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            newTimeline.tempImages.push({
                                file,
                                preview: ev.target.result
                            });
                        };
                        reader.readAsDataURL(file);
                    });
                    e.target.value = '';
                };

                const removeNewImage = (idx) => newTimeline.tempImages.splice(idx, 1);

                const saveTimelineRecord = async () => {
                    if (newTimeline.tempImages.length === 0 && !newTimeline.description.trim()) {
                        alert('ËØ∑Ëá≥Â∞ë‰∏ä‰º†‰∏ÄÂº†ÁÖßÁâáÊàñÂÜôÁÇπÊèèËø∞');
                        return;
                    }

                    try {
                        isSavingTimeline.value = true;
                        let uploadedUrls = [];

                        for (const item of newTimeline.tempImages) {
                            const res = await apiClient.uploadImage(item.file, {
                                potId: potId.value,
                                uploadType: 'timeline'
                            });
                            if (res.success && res.data?.url) {
                                uploadedUrls.push(res.data.url);
                            }
                        }

                        const recordData = {
                            potId: potId.value,
                            date: newTimeline.date,
                            description: newTimeline.description,
                            images: uploadedUrls
                        };

                        const saveRes = await apiClient.createTimeline(recordData);
                        if (saveRes.success) {
                            showAddTimelineModal.value = false;
                            newTimeline.description = '';
                            newTimeline.tempImages = [];
                            await loadTimelineRecords();
                        }
                    } catch (e) {
                        alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂêéÈáçËØï');
                    } finally {
                        isSavingTimeline.value = false;
                    }
                };

                const confirmDeleteTimeline = async (id) => {
                    if (confirm('Á°ÆËÆ§Âà†Èô§ËøôÊù°ÁîüÈïøËÆ∞ÂΩïÔºüÁÖßÁâá‰πüÂ∞Ü‰∏ÄÂπ∂Ê∏ÖÁêÜ„ÄÇ')) {
                        try {
                            const res = await apiClient.request(`/api/timelines/${id}`, { method: 'DELETE' });
                            if (res.success) await loadTimelineRecords();
                        } catch (e) { alert('Âà†Èô§Êìç‰ΩúÂ§±Ë¥•'); }
                    }
                };

                // ÁºñËæëËÆ∞ÂΩï
                const editRecord = (record) => {
                    window.location.href = `care-record.html?id=${record.id}`;
                };

                // Âà†Èô§ËÆ∞ÂΩï
                const deleteRecord = async (record) => {
                    if (!confirm('Á°ÆËÆ§Âà†Èô§ËøôÊù°ÂÖªÊä§ËÆ∞ÂΩïÔºü')) return;
                    try {
                        const res = await apiClient.request(`/api/care-records/${record.id}`, { method: 'DELETE' });
                        if (res.success) await loadCareRecords();
                    } catch (e) { alert('Êìç‰ΩúÂ§±Ë¥•'); }
                };

                // Êü•ÁúãÂÖ®ÈÉ®ËÆ∞ÂΩï
                const viewAllRecords = () => {
                    window.location.href = `all-records.html?potId=${potId.value}`;
                };

                // --- ËæÖÂä©ÂáΩÊï∞ ---
                const formatDate = (dateStr) => {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                };

                const getImages = (images) => {
                    if (!images) return [];
                    if (Array.isArray(images)) return images;
                    try { return JSON.parse(images); } catch (e) { return []; }
                };

                const getCareTypeIcon = (type) => {
                    const icons = { water: 'fas fa-tint', fertilize: 'fas fa-seedling', prune: 'fas fa-cut', repot: 'fas fa-exchange-alt', pest: 'fas fa-bug' };
                    return icons[type] || 'fas fa-clipboard-check';
                };

                const getCareTypeColor = (type) => {
                    const colors = { water: 'bg-blue-50 text-blue-500', fertilize: 'bg-green-50 text-green-500', prune: 'bg-orange-50 text-orange-500', repot: 'bg-purple-50 text-purple-500', pest: 'bg-red-50 text-red-500' };
                    return colors[type] || 'bg-gray-50 text-gray-500';
                };

                const getCareTypeLabel = (type) => {
                    const labels = { water: 'ÊµáÊ∞¥', fertilize: 'ÊñΩËÇ•', prune: '‰øÆÂâ™', repot: 'Êç¢ÁõÜ', pest: 'ÁóÖËô´ÂÆ≥' };
                    return labels[type] || 'Êó•Â∏∏';
                };

                const getCareIcon = (key) => {
                    const icons = {
                        careDifficulty: 'fas fa-tachometer-alt',
                        lightRequirement: 'fas fa-sun',
                        waterRequirement: 'fas fa-tint',
                        temperature: 'fas fa-thermometer-half',
                        humidity: 'fas fa-wind',
                        soilRequirement: 'fas fa-mountain',
                        droughtTolerance: 'fas fa-cactus',
                        shadeTolerance: 'fas fa-cloud',
                        coldTolerance: 'fas fa-snowflake',
                        watering: 'fas fa-shower',
                        fertilizing: 'fas fa-seedling',
                        pruning: 'fas fa-cut',
                        propagation: 'fas fa-vial',
                        pests: 'fas fa-bug',
                        safetyInfo: 'fas fa-shield-alt',
                        specialNotes: 'fas fa-exclamation-circle'
                    };
                    return icons[key] || 'fas fa-leaf';
                };

                const getCareLabel = (key) => {
                    const labels = {
                        careDifficulty: 'ÂÖªÊä§ÈöæÂ∫¶',
                        lightRequirement: 'ÂÖâÁÖßÈúÄÊ±Ç',
                        waterRequirement: 'Ê∞¥ÂàÜÈúÄÊ±Ç',
                        temperature: 'ÁîüÈïøÊ∏©Â∫¶',
                        humidity: 'ÁéØÂ¢ÉÊπøÂ∫¶',
                        soilRequirement: 'ÂúüÂ£§Ë¶ÅÊ±Ç',
                        droughtTolerance: 'ÊäóÊó±ÁâπÊÄß',
                        shadeTolerance: 'ËÄêÈò¥ÁâπÊÄß',
                        coldTolerance: 'ËÄêÂØíÁâπÊÄß',
                        watering: 'ÊµáÊ∞¥Ë¶ÅÁÇπ',
                        fertilizing: 'ÊñΩËÇ•Âª∫ËÆÆ',
                        pruning: '‰øÆÂâ™ÊäÄÂ∑ß',
                        propagation: 'ÁπÅÊÆñÊñπÂºè',
                        pests: 'ÁóÖËô´Èò≤Ê≤ª',
                        safetyInfo: 'ÂÆâÂÖ®ÊèêÁ§∫',
                        specialNotes: 'ÁâπÂà´ËØ¥Êòé'
                    };
                    return labels[key] || key;
                };

                const getOrnamentalLabel = (key) => {
                    const labels = {
                        category: 'Á±ªÂà´',
                        growthHabit: 'ÁîüÈïø‰π†ÊÄß',
                        flowerColor: 'Ëä±Ëâ≤',
                        floweringSeason: 'Ëä±Êúü',
                        fragrance: 'È¶ôÂë≥',
                        landscapeUse: 'Âõ≠ÊûóÁî®ÈÄî',
                        potSuitable: 'ÈÄÇÂêàÁõÜÊ†Ω',
                        symbolism: 'Ë±°ÂæÅÊÑè‰πâ'
                    };
                    return labels[key] || key;
                };

                const groupedCareRecords = computed(() => {
                    if (!careRecords.value.length) return [];
                    const groups = {};
                    careRecords.value.forEach(r => {
                        const d = formatDate(r.date);
                        if (!groups[d]) groups[d] = [];
                        groups[d].push(r);
                    });

                    return Object.keys(groups)
                        .sort((a, b) => new Date(b) - new Date(a)) // ÊåâÊó•ÊúüÂÄíÂ∫è
                        .map(date => {
                            const list = groups[date];
                            // ‰ºòÂÖàÊòæÁ§∫ÊúâÊèèËø∞ÁöÑÔºåÊàñËÄÖÂêàÂπ∂Âä®‰ΩúÂêç
                            const actions = [...new Set(list.map(i => i.action || getCareTypeLabel(i.type)))];
                            const types = [...new Set(list.map(i => i.type))];

                            // ÂêàÂπ∂ÊèèËø∞ÔºàÂéªÈáçÔºâ
                            const descriptions = list
                                .map(i => i.description)
                                .filter(d => d && !actions.includes(d)) // ÊéíÈô§Âè™ÊòØÈáçÂ§çÂä®‰ΩúÂêçÁöÑÊèèËø∞
                                .filter((v, i, a) => a.indexOf(v) === i); // ÂéªÈáç

                            return {
                                id: list[0].id, // ‰∏ªIDÔºåÁî®‰∫ékey
                                date: date,
                                records: list, // ÂéüÂßãËÆ∞ÂΩïÂàóË°®
                                isGroup: list.length > 1,
                                displayAction: actions.join('„ÄÅ'),
                                displayType: types[0], // Áî®‰∫éÂèñ‰∏ªÈ¢úËâ≤
                                allTypes: types,
                                displayDescription: descriptions.join('Ôºõ')
                            };
                        });
                });

                const careTipsGrid = computed(() => {
                    if (!plantInfo.value?.careGuide) return {};
                    return plantInfo.value.careGuide;
                });

                const transformPlantData = (d) => {
                    const safeParse = (val) => {
                        if (!val) return {};
                        if (typeof val === 'string') {
                            try { return JSON.parse(val); } catch (e) { console.warn('JSON parse failed', e); return {}; }
                        }
                        return val;
                    };

                    return {
                        basicInfo: safeParse(d.basic_info || d.basicInfo),
                        ornamentalFeatures: safeParse(d.ornamental_features || d.ornamentalFeatures),
                        careGuide: safeParse(d.care_guide || d.careGuide)
                    };
                };

                const handleImageError = (e) => {
                    e.target.src = 'assets/images/icons/icons-default-pot.png';
                };

                // --- Êô∫ËÉΩÊèêÈÜíÈÄªËæë ---
                const getScheduleHint = (type) => {
                    if (!plantInfo.value || !plantInfo.value.careGuide) return '';
                    const guide = plantInfo.value.careGuide;

                    switch (type) {
                        case 'water':
                            return guide.watering || guide.waterRequirement || '';
                        case 'fertilize':
                            return guide.fertilizing || '';
                        case 'trim':
                            return guide.pruning || '';
                        case 'repot':
                            return guide.soilRequirement || '';
                        case 'pest':
                            return guide.pests || '';
                        default:
                            return '';
                    }
                };

                const currentCareHint = computed(() => {
                    return getScheduleHint(newSchedule.careType);
                });

                const smartIntervalSuggestion = computed(() => {
                    const type = newSchedule.careType;
                    if (type === 'water' && avgWateringInterval.value !== '-') return avgWateringInterval.value;
                    if (type === 'fertilize' && avgFertilizingInterval.value !== '-') return avgFertilizingInterval.value;
                    return null;
                });

                const applySmartInterval = () => {
                    if (smartIntervalSuggestion.value) {
                        newSchedule.intervalDays = Math.round(Number(smartIntervalSuggestion.value));
                    }
                };

                const getCurrentSeason = () => {
                    const month = new Date().getMonth() + 1;
                    if (month >= 3 && month <= 5) return 'Spring';
                    if (month >= 6 && month <= 8) return 'Summer';
                    if (month >= 9 && month <= 11) return 'Autumn';
                    return 'Winter';
                };

                const getSeasonalTip = (careType) => {
                    if (!plantInfo.value || !plantInfo.value.careGuide) return null;

                    const season = getCurrentSeason();
                    const seasonKeywords = {
                        Spring: ['Êò•', 'ËêåËäΩ', 'Â§çËãè', 'ÁîüÈïø'],
                        Summer: ['Â§è', 'È´òÊ∏©', 'ÁÇéÁÉ≠'],
                        Autumn: ['Áßã', 'Âáâ', 'ËêΩÂè∂'],
                        Winter: ['ÂÜ¨', 'ÂØí', '‰ºëÁú†', 'Èò≤ÂÜª']
                    };

                    const keywords = seasonKeywords[season];
                    const guideKey = {
                        water: 'watering',
                        fertilize: 'fertilizing',
                        trim: 'pruning',
                        repot: 'soilRequirement',
                        pest: 'pests'
                    }[careType];

                    if (!guideKey) return null;

                    let text = plantInfo.value.careGuide[guideKey] || '';
                    if (!text) return null;

                    const segments = text.split(/[,Ôºå;Ôºõ„ÄÇ.\n]/).filter(s => s.trim().length > 2);

                    for (const segment of segments) {
                        for (const kw of keywords) {
                            if (segment.includes(kw)) {
                                return {
                                    season: season,
                                    text: segment.trim()
                                };
                            }
                        }
                    }

                    if (plantInfo.value.careGuide.specialNotes) {
                        const specialSegments = plantInfo.value.careGuide.specialNotes.split(/[,Ôºå;Ôºõ„ÄÇ.\n]/);
                        for (const segment of specialSegments) {
                            for (const kw of keywords) {
                                if (segment.includes(kw)) {
                                    return {
                                        season: season,
                                        text: segment.trim()
                                    };
                                }
                            }
                        }
                    }

                    return null;
                };

                onMounted(init);

                return {
                    isLoading, error, potId, pot, careRecords, timelineRecords, plantInfo, matchedPlantName,
                    showPlantModal, showAddTimelineModal, isSavingTimeline, fileInput,
                    previewImages, previewIndex,
                    newTimeline, sortedTimelineRecords, isTimelineDesc,
                    goBack, goEditPage, goAddCarePage, confirmDeletePot,
                    openGallery, closeGallery, prevImg, nextImg, toggleTimelineSort,
                    handleGalleryTouchStart, handleGalleryTouchMove, handleGalleryTouchEnd,
                    triggerFileInput, onFilesSelected, removeNewImage, saveTimelineRecord, confirmDeleteTimeline,
                    editRecord, deleteRecord, viewAllRecords,
                    formatDate, getImages, getCareTypeIcon, getCareTypeColor, getCareTypeLabel,
                    getCareIcon, getCareLabel, getOrnamentalLabel, careTipsGrid,
                    handleImageError, groupedCareRecords,
                    activeCareDate, showCareDetails, closeCareDetails, currentSheetGroup,
                    showFullPlantInfo, showFullCareTips, plantInfoGroups, careTipsGroups,
                    // ÂÖªÊä§ÁªüËÆ°
                    potStats, statsWaterCount, statsFertilizeCount, statsCareDays,
                    avgWateringInterval, avgFertilizingInterval,
                    // ÂÖªÊä§Âë®Êúü (Êñ∞Áâà)
                    careSchedules, showScheduleExpanded, showAddScheduleModal, newSchedule,
                    scheduleTypeOptions, intervalPresets, canSaveSchedule,
                    loadCareSchedules, saveNewSchedule, toggleScheduleEnabled, deleteSchedule, updateScheduleInterval,
                    getScheduleTypeStyle, getScheduleTypeName,
                    getScheduleHint, currentCareHint, smartIntervalSuggestion, applySmartInterval,
                    getSeasonalTip
                };
            }
        }).mount('#app');
    </script>

    <style>
        [v-cloak] {
            display: none;
        }

        .animate-slide-up {
            animation: slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .animate-fade-in {
            animation: fade-in 0.2s ease-out;
        }

        @keyframes slide-up {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        @keyframes fade-in {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Bottom Sheet Âä®Áîª */
        .bottom-sheet-enter-active,
        .bottom-sheet-leave-active {
            transition: all 0.4s cubic-bezier(0.32, 1, 0.23, 1);
        }

        .bottom-sheet-enter-from,
        .bottom-sheet-leave-to {
            transform: translateY(100%);
        }

        .backdrop-enter-active,
        .backdrop-leave-active {
            transition: opacity 0.3s ease;
        }

        .backdrop-enter-from,
        .backdrop-leave-to {
            opacity: 0;
        }

        /* ÈöêËóèÊªöÂä®Êù°‰ΩÜ‰øùÁïôÂäüËÉΩ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</body>

</html>