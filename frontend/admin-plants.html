<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>植物百科管理 - My Flower Pots</title>
    <!-- Tailwind CSS (Optimized) -->
    <link rel="stylesheet" href="css/tailwind-built.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', 'PingFang SC', sans-serif;
            background-color: #f8fafc;
        }

        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
        }

        .tab-active {
            border-bottom: 2px solid #10b981;
            color: #10b981;
        }

        [v-cloak] {
            display: none;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <div id="app" v-cloak>
        <!-- Security Loading Overlay -->
        <div v-if="isCheckingAccess" class="loading-overlay">
            <div class="w-16 h-16 border-4 border-emerald-500/20 border-t-emerald-500 rounded-full animate-spin mb-4">
            </div>
            <p class="text-slate-500 font-medium">安全校验中...</p>
        </div>

        <div v-else class="max-w-6xl mx-auto">
            <!-- Header -->
            <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                <div class="cursor-pointer group" onclick="window.location.href='index.html'">
                    <h1
                        class="text-3xl font-bold text-slate-800 flex items-center gap-3 transition-colors group-hover:text-emerald-600">
                        <i class="fas fa-shield-alt text-emerald-500"></i>
                        后台管理中心
                    </h1>
                    <p class="text-slate-500 mt-1 flex items-center gap-1">
                        <i class="fas fa-arrow-left text-xs opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        返回主页
                    </p>
                </div>
                <!-- 顶部页签切换 -->
                <div class="flex bg-slate-100 p-1 rounded-2xl">
                    <button @click="currentTab = 'plants'"
                        :class="currentTab === 'plants' ? 'bg-white shadow-sm text-emerald-600' : 'text-slate-500'"
                        class="px-6 py-2 rounded-xl font-medium transition-all">
                        植物百科
                    </button>
                    <button @click="currentTab = 'users'"
                        :class="currentTab === 'users' ? 'bg-white shadow-sm text-emerald-600' : 'text-slate-500'"
                        class="px-6 py-2 rounded-xl font-medium transition-all">
                        用户管理
                    </button>
                </div>
            </header>

            <!-- 植物管理视图 -->
            <div v-if="currentTab === 'plants'">
                <!-- Tools & Filters -->
                <div
                    class="glass border border-white rounded-2xl p-4 mb-6 flex flex-col md:flex-row gap-4 items-center shadow-sm">
                    <div class="relative flex-1 w-full">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" v-model="searchQuery" @keyup.enter="fetchPlants" placeholder="搜索植物名称或 ID..."
                            class="w-full pl-12 pr-4 py-3 rounded-xl border-none bg-slate-100 focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                    </div>
                    <div class="flex items-center gap-3">
                        <button @click="fetchPlants"
                            class="px-4 py-2 bg-slate-800 text-white rounded-xl hover:bg-slate-700 transition-all flex items-center gap-2">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                        <button @click="downloadTemplate"
                            class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-xl transition-all flex items-center gap-2">
                            <i class="fas fa-download"></i> 下载模板
                        </button>
                        <button @click="showImportModal = true"
                            class="px-4 py-2 bg-white border border-slate-200 text-slate-700 rounded-xl hover:shadow-md transition-all flex items-center gap-2">
                            <i class="fas fa-file-import"></i> 批量导入
                        </button>
                        <button @click="openCreateModal"
                            class="px-4 py-2 bg-emerald-500 text-white rounded-xl hover:bg-emerald-600 shadow-lg shadow-emerald-200 transition-all flex items-center gap-2">
                            <i class="fas fa-plus"></i> 新增植物
                        </button>
                    </div>
                </div>

                <!-- Table -->
                <div class="glass border border-white rounded-2xl overflow-hidden shadow-sm">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr>
                                <th class="px-6 py-4 w-12 text-center">
                                    <input type="checkbox" @change="toggleAll" :checked="isAllSelected"
                                        class="rounded border-slate-300 text-emerald-500 focus:ring-emerald-500">
                                </th>
                                <th class="px-6 py-4 font-semibold text-slate-600">ID / 名称</th>
                                <th class="px-6 py-4 font-semibold text-slate-600">分类</th>
                                <th class="px-6 py-4 font-semibold text-slate-600">养护难度</th>
                                <th class="px-6 py-4 font-semibold text-slate-600 text-right">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-for="plant in plants" :key="plant.id" class="hover:bg-slate-50 transition-colors">
                                <td class="px-6 py-4 text-center">
                                    <input type="checkbox" v-model="selectedIds" :value="plant.id"
                                        class="rounded border-slate-300 text-emerald-500 focus:ring-emerald-500">
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-3">
                                        <div
                                            class="w-10 h-10 rounded-lg bg-emerald-50 flex items-center justify-center text-emerald-500 overflow-hidden shrink-0">
                                            <img v-if="plant.image_url" :src="plant.image_url"
                                                class="w-full h-full object-cover">
                                            <i v-else class="fas fa-seedling"></i>
                                        </div>
                                        <div>
                                            <div class="font-medium text-slate-800">{{ plant.name }}</div>
                                            <div class="text-xs text-slate-400 font-mono">{{ plant.id }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="px-2 py-1 bg-slate-100 text-slate-600 rounded-md text-sm">{{
                                        plant.category
                                        || '未分类' }}</span>
                                </td>
                                <td class="px-6 py-4">
                                    <span :class="difficultyClass(plant.care_difficulty)"
                                        class="px-2 py-1 rounded-md text-sm">{{ plant.care_difficulty || '未知' }}</span>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <div class="flex items-center justify-end gap-2">
                                        <button @click="openEditModal(plant)"
                                            class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-emerald-500 hover:bg-emerald-50 rounded-lg transition-all">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button @click="deleteSingle(plant)"
                                            class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="flex items-center justify-between mt-6">
                    <p class="text-sm text-slate-500">共 {{ pagination.total }} 条记录</p>
                    <div class="flex items-center gap-2">
                        <button @click="changePage(pagination.page - 1)" :disabled="pagination.page === 1"
                            class="px-3 py-1 bg-white border border-slate-200 rounded-lg text-slate-600 disabled:opacity-50">上一页</button>
                        <span class="text-slate-600">{{ pagination.page }} / {{ totalPages }}</span>
                        <button @click="changePage(pagination.page + 1)" :disabled="pagination.page === totalPages"
                            class="px-3 py-1 bg-white border border-slate-200 rounded-lg text-slate-600 disabled:opacity-50">下一页</button>
                    </div>
                </div>
            </div>

            <!-- 用户管理视图 -->
            <div v-else-if="currentTab === 'users'">
                <!-- Tools & Filters -->
                <div class="glass border border-white rounded-2xl p-4 mb-6 flex gap-4 items-center shadow-sm">
                    <div class="relative flex-1">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" v-model="userSearchQuery" @keyup.enter="fetchUsers"
                            placeholder="搜索用户邮箱或 ID..."
                            class="w-full pl-12 pr-4 py-3 rounded-xl border-none bg-slate-100 focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                    </div>
                    <button @click="fetchUsers"
                        class="px-8 py-3 bg-slate-800 text-white rounded-xl hover:bg-slate-700 transition-all">
                        搜索
                    </button>
                </div>

                <!-- Table -->
                <div class="glass border border-white rounded-2xl overflow-hidden shadow-sm">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr>
                                <th class="px-6 py-4 font-semibold text-slate-600">用户信息</th>
                                <th class="px-6 py-4 font-semibold text-slate-600">用户名称</th>
                                <th class="px-6 py-4 font-semibold text-slate-600">类型 / 状态</th>
                                <th class="px-6 py-4 font-semibold text-slate-600">注册时间</th>
                                <th class="px-6 py-4 font-semibold text-slate-600">最后登录</th>
                                <th class="px-6 py-4 font-semibold text-slate-600">花盆数</th>
                                <th class="px-6 py-4 font-semibold text-slate-600 text-right">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-for="user in users" :key="user.id" class="hover:bg-slate-100 transition-colors">
                                <td class="px-6 py-4">
                                    <div class="font-medium text-slate-800">{{ user.email || '游客' }}</div>
                                    <div class="text-xs text-slate-400 font-mono">{{ user.id }}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-slate-700">{{ user.display_name || '-' }}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex flex-col gap-1">
                                        <span class="text-xs px-2 py-0.5 rounded-full w-fit"
                                            :class="user.user_type === 'email' ? 'bg-blue-50 text-blue-600' : 'bg-slate-100 text-slate-500'">
                                            {{ user.user_type === 'email' ? '邮箱用户' : '访客' }}
                                        </span>
                                        <span v-if="user.is_disabled"
                                            class="text-xs px-2 py-0.5 bg-red-50 text-red-600 rounded-full w-fit">已禁用</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-sm text-slate-500">
                                    {{ formatDateTime(user.created_at) }}
                                </td>
                                <td class="px-6 py-4 text-sm text-slate-500">
                                    {{ formatDateTime(user.last_login) || '-' }}
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-slate-700">{{ user.pot_count }}</span>
                                        <span class="text-slate-300">/</span>
                                        <span class="text-slate-500">{{ user.max_pots || (user.user_type === 'email' ?
                                            (user.email_verified ? 50 : 10) : 3) }}</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <div class="flex items-center justify-end gap-2">
                                        <button @click="openLimitModal(user)"
                                            class="px-3 py-1 text-sm bg-white border border-slate-200 text-slate-600 rounded-lg hover:border-emerald-500 hover:text-emerald-500 transition-all">
                                            调整上限
                                        </button>
                                        <button @click="toggleUserStatus(user)"
                                            :class="user.is_disabled ? 'text-emerald-600 hover:bg-emerald-50' : 'text-blue-500 hover:bg-blue-50'"
                                            class="px-3 py-1 text-sm bg-white border border-slate-200 rounded-lg transition-all">
                                            {{ user.is_disabled ? '启用' : '禁用' }}
                                        </button>
                                        <button @click="confirmDeleteUser(user)"
                                            class="px-3 py-1 text-sm bg-white border border-slate-200 text-red-500 hover:bg-red-50 rounded-lg transition-all">
                                            彻底删除
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="flex items-center justify-between mt-6">
                    <p class="text-sm text-slate-500">共 {{ userPagination.total }} 条用户</p>
                    <div class="flex items-center gap-2">
                        <button @click="changeUserPage(userPagination.page - 1)" :disabled="userPagination.page === 1"
                            class="px-3 py-1 bg-white border border-slate-200 rounded-lg text-slate-600 disabled:opacity-50">上一页</button>
                        <span class="text-slate-600">{{ userPagination.page }} / {{ totalUserPages }}</span>
                        <button @click="changeUserPage(userPagination.page + 1)"
                            :disabled="userPagination.page === totalUserPages"
                            class="px-3 py-1 bg-white border border-slate-200 rounded-lg text-slate-600 disabled:opacity-50">下一页</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Plant Edit/Create Modal -->
        <div v-if="showModal"
            class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm">
            <div class="bg-white rounded-3xl w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl overflow-hidden">
                <!-- Modal Header -->
                <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                    <h3 class="text-xl font-bold text-slate-800">{{ isEditing ? '编辑植物' : '新增植物' }}</h3>
                    <button @click="showModal = false" class="text-slate-400 hover:text-slate-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Tabs -->
                <div class="flex bg-slate-50 px-6">
                    <button v-for="t in tabs" :key="t.id" @click="activeTab = t.id"
                        :class="activeTab === t.id ? 'tab-active' : 'text-slate-400 border-transparent'"
                        class="px-6 py-4 font-medium transition-all border-b-2">
                        {{ t.name }}
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="p-6 overflow-y-auto flex-1 bg-white">
                    <!-- Tab: Basic -->
                    <div v-show="activeTab === 'basic'" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">唯一 ID (不可更改)</label>
                                <input type="text" v-model="formData.id" :readonly="isEditing"
                                    :class="isEditing ? 'bg-slate-100 cursor-not-allowed' : 'bg-white'"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                                <p class="text-xs text-slate-400 mt-1">例如: YueJi, JinZhanJu</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">植物名称</label>
                                <input type="text" v-model="formData.name"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">标准名称</label>
                                <input type="text" v-model="formData.basic_info.standard_name"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">拉丁名</label>
                                <input type="text" v-model="formData.basic_info.latinName"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">别名 (逗号分隔)</label>
                            <input type="text" v-model="synonymsInput"
                                class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">科属</label>
                                <input type="text" v-model="formData.basic_info.family"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">产地</label>
                                <input type="text" v-model="formData.basic_info.origin"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">主图 URL (可选)</label>
                            <div class="flex gap-2">
                                <input type="text" v-model="formData.image_url"
                                    class="flex-1 px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500"
                                    placeholder="https://...">
                                <button @click="triggerUpload"
                                    class="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl hover:bg-slate-200 transition-all">上传</button>
                            </div>
                            <input type="file" ref="fileInput" @change="handleUpload" class="hidden" accept="image/*">
                        </div>
                    </div>

                    <!-- Tab: Ornamental -->
                    <div v-show="activeTab === 'ornamental'" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">分类</label>
                                <input type="text" v-model="formData.category"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">生长习性</label>
                                <input type="text" v-model="formData.ornamental_features.growthHabit"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">花色</label>
                                <input type="text" v-model="formData.ornamental_features.flowerColor"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">花期</label>
                                <input type="text" v-model="formData.ornamental_features.floweringSeason"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">香味</label>
                                <input type="text" v-model="formData.ornamental_features.fragrance"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                            <div class="flex items-center gap-2 pt-8">
                                <input type="checkbox" v-model="formData.ornamental_features.potSuitable"
                                    class="w-5 h-5 rounded border-slate-300 text-emerald-500 focus:ring-emerald-500">
                                <label class="text-sm font-medium text-slate-600">适合盆栽</label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">园林用途</label>
                            <input type="text" v-model="formData.ornamental_features.landscapeUse"
                                class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">花语/象征</label>
                            <input type="text" v-model="formData.ornamental_features.symbolism"
                                class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                        </div>
                    </div>

                    <!-- Tab: Care -->
                    <div v-show="activeTab === 'care'" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">养护难度</label>
                                <select v-model="formData.care_difficulty"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                                    <option value="容易">容易</option>
                                    <option value="中等">中等</option>
                                    <option value="较高">较高</option>
                                    <option value="极高">极高</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">光照需求</label>
                                <input type="text" v-model="formData.care_guide.lightRequirement"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">水分需求</label>
                                <input type="text" v-model="formData.care_guide.waterRequirement"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">适宜温度</label>
                                <input type="text" v-model="formData.care_guide.temperature"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">耐旱性</label>
                                <input type="text" v-model="formData.care_guide.droughtTolerance"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">耐阴性</label>
                                <input type="text" v-model="formData.care_guide.shadeTolerance"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">耐寒性</label>
                                <input type="text" v-model="formData.care_guide.coldTolerance"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">浇水建议</label>
                                <textarea v-model="formData.care_guide.watering" rows="2"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">施肥建议</label>
                                <textarea v-model="formData.care_guide.fertilizing" rows="2"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">病虫害</label>
                                <input type="text" v-model="formData.care_guide.pests"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">安全信息 (有毒/无毒)</label>
                                <input type="text" v-model="formData.care_guide.safetyInfo"
                                    class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">特殊说明</label>
                            <textarea v-model="formData.care_guide.specialNotes" rows="2"
                                class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="p-6 border-t border-slate-100 flex items-center justify-end gap-3">
                    <button @click="showModal = false"
                        class="px-6 py-2 text-slate-600 hover:bg-slate-50 rounded-xl transition-all">取消</button>
                    <button @click="savePlant" :disabled="saving"
                        class="px-8 py-2 bg-emerald-500 text-white rounded-xl hover:bg-emerald-600 shadow-lg shadow-emerald-200 transition-all flex items-center gap-2">
                        <i v-if="saving" class="fas fa-spinner fa-spin"></i>
                        {{ saving ? '保存中...' : '提交保存' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Batch Import Modal -->
        <div v-if="showImportModal"
            class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm">
            <div class="bg-white rounded-3xl w-full max-w-2xl shadow-2xl overflow-hidden p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-slate-800">批量导入植物数据</h3>
                    <button @click="showImportModal = false" class="text-slate-400 hover:text-slate-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-600 mb-2">请粘贴 JSON 数组：</label>
                    <textarea v-model="importJson" rows="12"
                        class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 font-mono text-sm outline-none focus:ring-2 focus:ring-emerald-500"
                        placeholder="[{ 'id': '...', 'name': '...' }, ...]"></textarea>
                </div>
                <div class="flex items-center justify-between">
                    <div class="text-xs text-slate-400 max-w-[60%]">
                        * 注意：导入将会按 ID 更新现有数据，请确保 JSON 格式正确且符合模板规范。
                    </div>
                    <div class="flex gap-2">
                        <button @click="showImportModal = false"
                            class="px-6 py-2 text-slate-600 hover:bg-slate-50 rounded-xl transition-all">取消</button>
                        <button @click="doImport" :disabled="!importJson || importing"
                            class="px-6 py-2 bg-emerald-500 text-white rounded-xl hover:bg-emerald-600 transition-all flex items-center gap-2">
                            <i v-if="importing" class="fas fa-spinner fa-spin"></i>
                            {{ importing ? '处理中...' : '开始导入' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Limit Adjustment Modal -->
        <div v-if="showLimitModal"
            class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm">
            <div class="bg-white rounded-3xl w-full max-w-md shadow-2xl overflow-hidden p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-slate-800">调整用户花盆上限</h3>
                    <button @click="showLimitModal = false" class="text-slate-400 hover:text-slate-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-2">用户邮箱</label>
                        <p class="text-slate-800 font-medium">{{ activeUser?.email || '访客' }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-2">新的上限值</label>
                        <input type="number" v-model="newLimit"
                            class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500"
                            placeholder="留空即回复系统默认设置">
                        <p class="text-xs text-slate-400 mt-2">
                            * 留空表示跟随系统默认规则（普通 10 / 已验证 50）。设置极大数值（如 9999）即为无限名额。
                        </p>
                    </div>
                </div>
                <div class="flex gap-3 mt-8">
                    <button @click="showLimitModal = false"
                        class="flex-1 py-3 text-slate-600 hover:bg-slate-50 rounded-xl transition-all">取消</button>
                    <button @click="saveLimit" :disabled="savingLimit"
                        class="flex-1 py-3 bg-emerald-500 text-white rounded-xl hover:bg-emerald-600 transition-all">
                        {{ savingLimit ? '正在保存...' : '确认修改' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div v-if="toast.show"
            class="fixed bottom-8 left-1/2 -translate-x-1/2 px-6 py-3 bg-slate-800 text-white rounded-2xl shadow-xl flex items-center gap-3 transition-all animate-bounce">
            <i :class="toast.icon"></i>
            {{ toast.message }}
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/api-client.js"></script>
    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const currentTab = ref('plants'); // 'plants' or 'users'

                // 植物管理相关
                const plants = ref([]);
                const pagination = ref({ page: 1, pageSize: 20, total: 0 });
                const searchQuery = ref('');
                const selectedIds = ref([]);
                const showModal = ref(false);
                const showImportModal = ref(false);
                const isEditing = ref(false);
                const activeTab = ref('basic');
                const saving = ref(false);
                const importing = ref(false);
                const importJson = ref('');
                const synonymsInput = ref('');

                // 用户管理相关
                const users = ref([]);
                const userPagination = ref({ page: 1, pageSize: 20, total: 0 });
                const userSearchQuery = ref('');
                const showLimitModal = ref(false);
                const activeUser = ref(null);
                const newLimit = ref('');
                const savingLimit = ref(false);

                const toast = ref({ show: false, message: '', icon: '' });
                const isCheckingAccess = ref(true);

                const tabs = [
                    { id: 'basic', name: '基本信息' },
                    { id: 'ornamental', name: '观赏特性' },
                    { id: 'care', name: '养护指南' }
                ];

                const formData = ref({
                    id: '',
                    name: '',
                    category: '',
                    care_difficulty: '中等',
                    image_url: '',
                    basic_info: {},
                    ornamental_features: {},
                    care_guide: {}
                });

                const totalPages = computed(() => Math.ceil(pagination.value.total / pagination.value.pageSize));
                const totalUserPages = computed(() => Math.ceil(userPagination.value.total / userPagination.value.pageSize));
                const isAllSelected = computed(() => plants.value.length > 0 && selectedIds.value.length === plants.value.length);

                const fetchPlants = async () => {
                    try {
                        const res = await apiClient.adminGetPlants(pagination.value.page, pagination.value.pageSize, searchQuery.value);
                        if (res.success) {
                            plants.value = res.data;
                            pagination.value.total = res.pagination.total;
                        }
                    } catch (err) {
                        showToast(err.message, 'fas fa-exclamation-circle');
                    }
                };

                const fetchUsers = async () => {
                    try {
                        const res = await apiClient.adminGetUsers(userPagination.value.page, userPagination.value.pageSize, userSearchQuery.value);
                        if (res.success) {
                            users.value = res.data;
                            userPagination.value.total = res.pagination.total;
                        }
                    } catch (err) {
                        showToast(err.message, 'fas fa-exclamation-circle');
                    }
                };

                // 监听页签切换自动加载数据
                watch(currentTab, (newVal) => {
                    if (newVal === 'plants') fetchPlants();
                    if (newVal === 'users') fetchUsers();
                });

                const changePage = (p) => {
                    if (p < 1 || p > totalPages.value) return;
                    pagination.value.page = p;
                    fetchPlants();
                };

                const changeUserPage = (p) => {
                    if (p < 1 || p > totalUserPages.value) return;
                    userPagination.value.page = p;
                    fetchUsers();
                };

                const toggleAll = () => {
                    if (isAllSelected.value) {
                        selectedIds.value = [];
                    } else {
                        selectedIds.value = plants.value.map(p => p.id);
                    }
                };

                const difficultyClass = (d) => {
                    switch (d) {
                        case '容易': return 'bg-emerald-50 text-emerald-600';
                        case '中等': return 'bg-blue-50 text-blue-600';
                        case '较高': return 'bg-amber-50 text-amber-600';
                        case '极高': return 'bg-red-50 text-red-600';
                        default: return 'bg-slate-100 text-slate-500';
                    }
                };

                const openLimitModal = (user) => {
                    activeUser.value = user;
                    newLimit.value = user.max_pots || '';
                    showLimitModal.value = true;
                };

                const saveLimit = async () => {
                    savingLimit.value = true;
                    try {
                        const res = await apiClient.adminUpdateUser(activeUser.value.id, { maxPots: newLimit.value });
                        if (res.success) {
                            showToast('限额更新成功', 'fas fa-check-circle');
                            showLimitModal.value = false;
                            fetchUsers();
                        }
                    } catch (err) {
                        showToast(err.message, 'fas fa-exclamation-circle');
                    } finally {
                        savingLimit.value = false;
                    }
                };

                const toggleUserStatus = async (user) => {
                    const action = user.is_disabled ? '启用' : '禁用';
                    if (!confirm(`确定要${action}用户 "${user.email || user.id}" 吗？`)) return;

                    try {
                        const res = await apiClient.adminUpdateUser(user.id, { isDisabled: !user.is_disabled });
                        if (res.success) {
                            showToast(`用户已${action}`, 'fas fa-check-circle');
                            fetchUsers();
                        }
                    } catch (err) {
                        showToast(err.message, 'fas fa-exclamation-circle');
                    }
                };

                const confirmDeleteUser = async (user) => {
                    const confirmMsg = `❗ 危险警告 ❗\n\n您确定要彻底删除用户 "${user.email || user.id}" 吗？\n\n该操作将：\n1. 永久删除该账号\n2. 物理删除所有关联花盆及成长记录\n3. 彻底清除 R2 存储中的所有相关图片文件\n\n此操作不可撤销，确定继续吗？`;
                    if (!confirm(confirmMsg)) return;

                    showToast('正在深度清理用户数据...', 'fas fa-spinner fa-spin');
                    try {
                        const res = await apiClient.adminDeleteUser(user.id);
                        if (res.success) {
                            showToast('用户及关联数据已彻底清除', 'fas fa-trash-alt');
                            fetchUsers();
                        }
                    } catch (err) {
                        showToast(err.message, 'fas fa-exclamation-circle');
                    }
                };

                const openCreateModal = () => {
                    isEditing.value = false;
                    activeTab.value = 'basic';
                    synonymsInput.value = '';
                    formData.value = {
                        id: '', name: '', category: '', care_difficulty: '中等', image_url: '',
                        basic_info: {}, ornamental_features: {}, care_guide: {}
                    };
                    showModal.value = true;
                };

                const openEditModal = (plant) => {
                    isEditing.value = true;
                    activeTab.value = 'basic';
                    // 深拷贝
                    formData.value = JSON.parse(JSON.stringify(plant));
                    synonymsInput.value = (plant.synonyms || []).join(', ');
                    showModal.value = true;
                };

                const savePlant = async () => {
                    if (!formData.value.id || !formData.value.name) {
                        return showToast('ID 和名称不能为空', 'fas fa-exclamation-triangle');
                    }

                    // 处理别名
                    const synonyms = synonymsInput.value.split(',')
                        .map(s => s.trim())
                        .filter(s => s.length > 0);

                    const payload = {
                        ...formData.value,
                        synonyms
                    };

                    saving.value = true;
                    try {
                        let res;
                        if (isEditing.value) {
                            res = await apiClient.adminUpdatePlant(formData.value.id, payload);
                        } else {
                            res = await apiClient.adminCreatePlant(payload);
                        }

                        if (res.success) {
                            showToast('保存成功', 'fas fa-check-circle');
                            showModal.value = false;
                            fetchPlants();
                        }
                    } catch (err) {
                        showToast(err.message, 'fas fa-exclamation-circle');
                    } finally {
                        saving.value = false;
                    }
                };

                const deleteSingle = async (plant) => {
                    if (!confirm(`确定要删除植物 "${plant.name}" 吗？此操作不可撤销。`)) return;
                    try {
                        const res = await apiClient.adminDeletePlant(plant.id);
                        if (res.success) {
                            showToast('删除成功', 'fas fa-trash');
                            fetchPlants();
                        }
                    } catch (err) {
                        showToast(err.message, 'fas fa-exclamation-circle');
                    }
                };

                const batchDelete = async () => {
                    if (!confirm(`确定要删除选中的 ${selectedIds.value.length} 个植物吗？`)) return;
                    try {
                        const res = await apiClient.adminBatchDelete(selectedIds.value);
                        if (res.success) {
                            showToast('批量删除成功', 'fas fa-trash-alt');
                            selectedIds.value = [];
                            fetchPlants();
                        }
                    } catch (err) {
                        showToast(err.message, 'fas fa-exclamation-circle');
                    }
                };

                const doImport = async () => {
                    try {
                        const data = JSON.parse(importJson.value);
                        if (!Array.isArray(data)) throw new Error('必须是一个 JSON 数组');

                        importing.value = true;
                        const res = await apiClient.adminBatchImport(data);
                        if (res.success) {
                            showToast(`导入完成：成功 ${res.results.success}, 失败 ${res.results.failed}`, 'fas fa-info-circle');
                            showImportModal.value = false;
                            importJson.value = '';
                            fetchPlants();
                        }
                    } catch (err) {
                        alert('JSON 格式错误: ' + err.message);
                    } finally {
                        importing.value = false;
                    }
                };

                const downloadTemplate = () => {
                    const template = [{
                        id: "PinYin",
                        basicInfo: {
                            name: "名称", standard_name: "标准名", latinName: "拉丁名",
                            synonyms: ["别名1", "别名2"], family: "科属", origin: "产地"
                        },
                        ornamentalFeatures: {
                            category: "分类", growthHabit: "生长习性", flowerColor: "花色",
                            floweringSeason: "花期", fragrance: "香味", landscapeUse: "用途",
                            potSuitable: true, symbolism: "象征"
                        },
                        careGuide: {
                            careDifficulty: "容易/中等/较高", lightRequirement: "光照",
                            waterRequirement: "水分", temperature: "15–30℃", humidity: "湿度",
                            soilRequirement: "土壤", droughtTolerance: "耐旱", shadeTolerance: "耐阴",
                            coldTolerance: "耐寒", watering: "浇水建议", fertilizing: "施肥建议",
                            pruning: "修剪", propagation: "繁殖", pests: "病虫",
                            safetyInfo: "安全说明", specialNotes: "特殊说明"
                        }
                    }];
                    const blob = new Blob([JSON.stringify(template, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'plant_import_template.json';
                    a.click();
                    URL.revokeObjectURL(url);
                };

                // 格式化日期时间
                const formatDateTime = (dateStr) => {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    if (isNaN(date.getTime())) return '';
                    const y = date.getFullYear();
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const d = String(date.getDate()).padStart(2, '0');
                    const h = String(date.getHours()).padStart(2, '0');
                    const min = String(date.getMinutes()).padStart(2, '0');
                    return `${y}-${m}-${d} ${h}:${min}`;
                };

                const showToast = (msg, icon) => {
                    toast.value = { show: true, message: msg, icon };
                    setTimeout(() => toast.value.show = false, 3000);
                };

                // Image Upload
                const fileInput = ref(null);
                const triggerUpload = () => fileInput.value.click();
                const handleUpload = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        showToast('正在上传图片...', 'fas fa-spinner fa-spin');
                        // 使用通用上传接口，这里传入 plantId 作为目录后缀
                        const res = await apiClient.uploadImage(file, {
                            uploadType: 'plants',
                            entityId: formData.value.id || 'temp'
                        });
                        if (res.success) {
                            formData.value.image_url = res.url;
                            showToast('图片上传成功', 'fas fa-check-circle');
                        }
                    } catch (err) {
                        showToast(err.message, 'fas fa-exclamation-circle');
                    }
                };

                const checkAccess = async () => {
                    const token = localStorage.getItem('flowerpots_token');
                    if (!token) {
                        window.location.href = 'index.html';
                        return;
                    }

                    try {
                        const res = await apiClient.adminCheck();
                        if (res.success) {
                            isCheckingAccess.value = false;
                            fetchPlants();
                        } else {
                            alert('无管理员权限，即将跳转回主页。错误: ' + (res.message || '未知错误'));
                            window.location.href = 'index.html';
                        }
                    } catch (err) {
                        console.error('Access check failed:', err);
                        alert('权限校验失败: ' + err.message + '\n请检查是否已使用管理员账号登录。');
                        window.location.href = 'index.html';
                    }
                };

                onMounted(checkAccess);

                return {
                    currentTab, plants, pagination, searchQuery, selectedIds, totalPages, isAllSelected,
                    showModal, isEditing, activeTab, tabs, formData, saving, synonymsInput,
                    showImportModal, importJson, importing, toast, fileInput, isCheckingAccess,
                    users, userPagination, userSearchQuery, showLimitModal, activeUser, newLimit, savingLimit, totalUserPages,
                    fetchPlants, fetchUsers, changePage, changeUserPage, toggleAll, difficultyClass, openCreateModal,
                    openEditModal, savePlant, deleteSingle, batchDelete, downloadTemplate, formatDateTime,
                    doImport, triggerUpload, handleUpload, openLimitModal, saveLimit, toggleUserStatus, confirmDeleteUser
                };
            }
        }).mount('#app');
    </script>
</body>

</html>